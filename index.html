<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Pasiecznik ULTRA PRO</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#A9711C">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Miodowo-le≈õny (B1) */
      --primary:#D9A441;          /* mi√≥d jasny */
      --primary-dark:#A9711C;     /* bursztyn */

      --bg:#F4F1EC;               /* ciep≈Çy be≈º t≈Ça */
      --white:#FFFDF8;            /* ciep≈Ça biel kart */
      --text:#1F2A24;             /* ciemna ziele≈Ñ-czer≈Ñ */

      --danger:#9C3A2B;           /* naturalna czerwie≈Ñ */
      --success:#2F5D50;          /* ziele≈Ñ lasu */
      --blue:#6B7F3E;             /* oliwka (akcje pomocnicze) */

      --slate:#7A5C3E;            /* drewno */
      --purple:#2F5D50;           /* le≈õny akcent (zamiast fioletu) */
      --emerald:#2F5D50;          /* le≈õny */
      --orange:#E3B23C;           /* zgaszony ≈º√≥≈Çty */

      --border:#E6DCCF;           /* ciep≈Çy obrys */
    }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding-bottom: 90px;
        -webkit-font-smoothing: antialiased;
        overscroll-behavior: none; /* Blokuje "odbijanie" strony na iOS/Android */
        touch-action: pan-y; /* Pozwala tylko na przewijanie pionowe listy */
    }

    .header{background:var(--primary);color:#fff;padding:12px;position:sticky;top:0;z-index:50;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .header-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .header-title{font-weight:700;text-transform:uppercase;letter-spacing:0.5px;font-size:1.05rem}
    .nav-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:5px;scrollbar-width:none}
    .nav-scroll::-webkit-scrollbar{display:none}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media (min-width:640px){.grid-hives{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:768px){.grid-hives{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:1024px){.grid-hives{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:639px){.grid-hives{grid-template-columns:repeat(2,1fr)}}
    
    .btn{border:none;padding:8px 16px;border-radius:10px;font-weight:600;cursor:pointer;text-transform:uppercase;font-size:.75rem;transition:.2s;color:#fff;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap; letter-spacing: 0.3px;}
    .btn:active{transform:scale(.96)}
    .btn-nav{background:var(--primary-dark);border:1px solid rgba(255,255,255,.18)}
    .btn-green{background:var(--success)}
    .btn-red{background:var(--danger)}
    .btn-blue{background:var(--blue)}
    .btn-slate{background:var(--slate)}
    .btn-orange{background:var(--orange)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn-ghost:active{transform:scale(.98)}
    .btn-chip{background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.12);padding:8px 10px}
    .btn-chip.active{background:var(--blue)}
    .btn-chip.active-red{background:var(--danger)}
    .btn-chip.active-slate{background:var(--slate); border-color:#fff;}
    .card{background:var(--white);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);border:1px solid var(--border)}
    .input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;box-sizing:border-box;background:#fff; font-family: inherit;}
    .input:focus{outline:2px solid var(--primary);border-color:transparent}
    .hidden{display:none!important}
    .flex{display:flex}
    .gap-2{gap:8px}
    .gap-3{gap:12px}
    .justify-between{justify-content:space-between}
    .items-center{align-items:center}
    .w-full{width:100%}
    .text-center{text-align:center}
    .mb-2{margin-bottom:8px}
    .mt-2{margin-top:8px}
    .mt-3{margin-top:12px}
    
    .hive-card{border-bottom:6px solid var(--primary);cursor:pointer;transition:transform .2s}
    .hive-card:hover{transform:translateY(-2px)}
    .hive-card.archived{opacity:0.7; filter:grayscale(0.8); border-bottom-color:#94a3b8;}
    .text-alert{color:var(--danger);font-weight:700;animation:blink 2s infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:.55}100%{opacity:1}}
    
    details{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff}
    details>summary{background:#f8fafc;padding:12px;font-weight:700;cursor:pointer;list-style:none;font-size:.8rem;text-transform:uppercase;color:#475569;display:flex;justify-content:space-between;align-items:center; letter-spacing: 0.5px;}
    details[open]>summary{background:#e2e8f0}
    .details-content{padding:12px;border-top:1px solid var(--border);display:grid;gap:10px}
    
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:600;font-size:11px;border:1px solid var(--border);background:#fff}
    .muted{color:#64748b;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:1px}
    .small{font-size:12px;color:#64748b;font-weight:500}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .lbl { display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase;}

    /* Confirm dialog */
    .confirm-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .confirm-overlay.show{display:flex}
    .confirm-box{width:min(520px,100%);background:#fff;border-radius:18px;border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    .confirm-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .confirm-title{font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:14px}
    .confirm-body{padding:16px}
    .confirm-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:110px;transform:translateX(-50%);background:#0f172a;color:#fff;
      padding:10px 14px;border-radius:14px;font-weight:600;box-shadow:0 10px 30px rgba(0,0,0,.25);
      z-index:10001;max-width:min(560px,92%);text-align:center;display:none}
    .toast.show{display:block}

    /* Voice recording animation */
    .btn-mic-active {
        background-color: var(--danger) !important;
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    /* MAPA STYLES - FIXED COORDINATES SYSTEM */
    .map-container {
        width: 100%;
        height: 75vh;
        border: 2px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: #e2e8f0; 
        position: relative;
    }
    .map-viewport {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden; 
        /* KLUCZOWE: Blokuje scrollowanie strony w tym obszarze */
        touch-action: none; 
        cursor: grab;
    }
    .map-viewport:active {
        cursor: grabbing;
    }
    /* T≈ÅO I POWIERZCHNIA W JEDNYM */
    .map-surface {
        width: 3000px;
        height: 3000px;
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: 0 0;
        
        background-color: #6B7F3E; 
        background-image: url("data:image/svg+xml,%3Csvg width='56' height='100' viewBox='0 0 56 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M28 66L0 50L0 16L28 0L56 16L56 50L28 66L28 100' fill='none' stroke='%23D9A441' stroke-width='1' opacity='0.15'/%3E%3Cpath d='M28 0L28 34L0 50L0 84L28 100L56 84L56 50L28 34' fill='none' stroke='%23D9A441' stroke-width='1' opacity='0.15'/%3E%3C/svg%3E");
        background-size: 56px 100px;
        background-repeat: repeat;
    }
    .map-hive {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 10;
        cursor: grab;
        touch-action: none; 
        user-select: none;
    }
    .map-hive.dragging {
        z-index: 999;
        cursor: grabbing;
        transform: scale(1.2);
    }
    .hive-icon {
        width: 48px;
        height: 48px;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        transition: transform 0.2s;
    }
    .hive-label {
        margin-top: -6px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--slate);
        color: var(--text);
        font-size: 11px;
        font-weight: 800;
        padding: 2px 6px;
        border-radius: 6px;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    }
    .map-controls {
        position: absolute;
        bottom: 16px;
        right: 16px;
        display: flex;
        gap: 8px;
        z-index: 100;
    }
    .btn-map {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--white);
        border: 1px solid var(--border);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .btn-map:active { transform: scale(0.95); }
    .map-hint {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: #fff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        pointer-events: none;
        z-index: 100;
        white-space: nowrap;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="flex items-center gap-2">
      <button id="backBtn" class="btn btn-nav hidden" aria-label="Wstecz">‚¨Ö</button>
      <div id="appTitle" class="header-title">PASIECZNIK ULTRA</div>
    </div>
    <div class="flex gap-2">
      <button id="exportBtn" class="btn btn-green">‚¨á KOPIA</button>
      <label class="btn btn-slate" style="cursor:pointer">
        ‚¨Ü IMPORT
        <input id="importFile" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>

  <div class="nav-scroll" id="topNav">
    <button data-view="hives" class="btn btn-nav">üêù Pasieka</button>
    <button data-view="map" class="btn btn-nav" style="background:var(--blue)">üó∫Ô∏è Mapa</button>
    <button data-view="calendar" class="btn btn-nav" style="background:var(--success)">üìÖ Kalendarz</button>
    <button data-view="finance" class="btn btn-nav" style="background:var(--emerald)">üí∞ Finanse</button>
    <button data-view="inventory" class="btn btn-nav" style="background:var(--slate)">üì¶ Magazyn</button>
    <button data-view="knowledge" class="btn btn-nav" style="background:var(--purple)">üß† Wiedza</button>
    <button id="addHiveBtn" class="btn btn-green">+ UL</button>
  </div>
</header>

<main class="container">
  <section id="viewHives" class="grid">
    <div class="card" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">FILTRY EKRANU G≈Å√ìWNEGO</div>
      <div class="flex gap-2" style="flex-wrap:wrap">
        <button id="fltReviewBtn" class="btn btn-chip">üîé DO PRZEGLƒÑDU</button>
        <button id="fltQueenBtn" class="btn btn-chip">üëë MATKA DO WYMIANY</button>
        |
        <button id="fltArchivedBtn" class="btn btn-chip">üóÑÔ∏è ARCHIWUM</button>
        <button id="fltClearBtn" class="btn btn-ghost" style="padding:8px 10px">WYCZY≈öƒÜ</button>
      </div>
      <div class="small mt-2">
        ‚ÄûDo przeglƒÖdu‚Äù = ul z terminem nastƒôpnego przeglƒÖdu na dzi≈õ / wstecz, albo (je≈õli brak terminu) ostatni przeglƒÖd starszy ni≈º 6 dni.<br/>
        ‚ÄûMatka do wymiany‚Äù = aktualna matka ma wiek &gt;= 24 miesiƒÖce.<br/>
        ‚ÄûArchiwum‚Äù = ule nieaktywne (np. po≈ÇƒÖczone).
      </div>
    </div>
    <div id="hivesGrid" class="grid grid-hives"></div>
  </section>

  <section id="viewMap" class="hidden">
      <div class="card" style="padding:0; overflow:hidden;">
          <div class="map-container" id="mapContainer">
              <div class="map-hint">Dwa palce: Zoom. Jeden palec: Przesu≈Ñ.</div>
              <div class="map-viewport" id="mapViewport">
                  <div class="map-surface" id="mapSurface">
                      </div>
              </div>
              <div class="map-controls">
                  <button id="btnFitMap" class="btn-map" title="Ca≈Ça pasieka">üîç</button>
              </div>
          </div>
          <div class="small" style="padding:10px; background:var(--white);">
              To jest rzut Twojej pasieki. U≈ºyj przycisku lupy, aby zobaczyƒá wszystko.
          </div>
      </div>
  </section>

  <section id="viewDetails" class="hidden grid">
    <div class="card" style="border-left:6px solid var(--primary)">
      <div class="muted">UL</div>
      <div id="detailsTitle" style="font-weight:700;font-size:18px;margin-top:6px"></div>
      <div class="hr"></div>

      <div class="row cols2">
        <input id="hLabel" class="input" type="text" placeholder="Numer / nazwa ula (np. 12, A1)">
        <input id="hPlace" class="input" type="text" placeholder="Po≈Ço≈ºenie (np. RzƒÖd 2 / 3 od lewej)">
      </div>
      <div class="row cols3">
        <select id="hType" class="input">
          <option value="rodzina">Rodzina</option>
          <option value="odklad">Odk≈Çad</option>
        </select>
        <input id="hYear" class="input" type="number" placeholder="Rok (np. 2025)">
        <input id="hNextVisit" class="input" type="date" title="Termin nastƒôpnego przeglƒÖdu">
      </div>
      <div class="row">
        <button id="saveHiveMetaBtn" class="btn btn-blue w-full">ZAPISZ METADANE ULA</button>
      </div>
    </div>

    <details open>
      <summary>üîé PrzeglƒÖdy <span class="small" id="reviewsCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <label>
             <span class="lbl">Data przeglƒÖdu</span>
             <input id="revDate" type="date" class="input">
          </label>
          <label>
             <span class="lbl">Nastƒôpny przeglƒÖd (Plan)</span>
             <input id="revNext" type="date" class="input">
          </label>
          <div style="display:flex; align-items:flex-end">
             <button id="revSaveBtn" class="btn btn-blue w-full" style="height:42px">ZAPISZ</button>
          </div>
        </div>
        
        <div class="flex items-center gap-2 mt-2">
            <button id="voiceNoteBtn" class="btn btn-slate w-full">üé§ NAGRAJ NOTATKƒò (Start/Stop)</button>
        </div>
        <div class="small text-center mt-2" style="font-size:10px; color:#64748b;">Powiedz "KONIEC NAGRYWANIA" aby zapisaƒá automatycznie.</div>
        
        <textarea id="revNote" class="input mt-2" style="height:90px" placeholder="Notatka z przeglƒÖdu (pisz lub dyktuj)..."></textarea>
        <div class="small">Mo≈ºesz edytowaƒá wpis: kliknij ‚ÄûEdytuj‚Äù przy przeglƒÖdzie.</div>
        <div id="revList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <details>
      <summary>üçØ Karmienie <span class="small" id="feedCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="feedDate" type="date" class="input">
          <select id="feedType" class="input">
            <option value="syrop">Syrop</option>
            <option value="ciasto">Ciasto</option>
            <option value="inny">Inny</option>
          </select>
          <input id="feedQty" type="number" step="0.01" class="input" placeholder="Ilo≈õƒá (kg lub l)">
        </div>
        <input id="feedNote" type="text" class="input" placeholder="Notatka (opcjonalnie)">
        <div class="row cols2">
          <button id="feedSaveBtn" class="btn btn-slate">ZAPISZ KARMIENIE</button>
          <button id="feedClearBtn" class="btn btn-ghost">WYCZY≈öƒÜ EDYCJƒò</button>
        </div>
        <div id="feedList" class="grid" style="gap:10px"></div>
      </div>
    </details>


    <details>
      <summary>üíä Leczenie <span class="small" id="treatCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="treatDate" type="date" class="input">
          <input id="treatType" type="text" class="input" placeholder="Lek / ≈õrodek">
          <input id="treatQty" type="text" class="input" placeholder="Ilo≈õƒá (np. ml, g, paski)">
        </div>
        <div class="row cols2">
          <button id="treatSaveBtn" class="btn btn-red">ZAPISZ LECZENIE</button>
          <button id="treatClearBtn" class="btn btn-ghost">WYCZY≈öƒÜ</button>
        </div>
        <div id="treatList" class="grid" style="gap:10px"></div>
      </div>
    </details>


    <details>
      <summary>üëë Matki (historia) <span class="small" id="queenCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="qName" type="text" class="input" placeholder="Nazwa matki (np. Mira)">
          <input id="qYear" type="number" class="input" placeholder="Rocznik (np. 2024)">
          <input id="qMonth" type="number" min="1" max="12" class="input" placeholder="MiesiƒÖc (1-12)">
        </div>
        <div class="row cols3">
          <input id="qMating" type="text" class="input" placeholder="Typ unasienniania (opcjonalnie)">
          <input id="qLine" type="text" class="input" placeholder="Linia / hodowca (opcjonalnie)">
          <input id="qOpalit" type="text" class="input" placeholder="Kolor opalitki / brak (opcjonalnie)">
        </div>
        <div class="row cols2">
          <select id="qGentle" class="input">
            <option value="">≈Åagodno≈õƒá (opcjonalnie)</option>
            <option value="1">1 ‚Äì trudna</option>
            <option value="2">2</option>
            <option value="3">3 ‚Äì OK</option>
            <option value="4">4</option>
            <option value="5">5 ‚Äì super</option>
          </select>
          <button id="queenSaveBtn" class="btn" style="background:var(--purple)">ZAPISZ MATKƒò</button>
        </div>
        <textarea id="qNote" class="input" style="height:80px" placeholder="Wolna notatka (opcjonalnie)"></textarea>
        <div class="row cols2">
          <button id="queenClearBtn" class="btn btn-ghost">WYCZY≈öƒÜ EDYCJƒò</button>
          <div class="small">Kliknij ‚ÄûUstaw aktualnƒÖ‚Äù na wpisie, ≈ºeby oznaczyƒá aktualnƒÖ matkƒô w ulu.</div>
        </div>
        <div id="queenList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <details>
      <summary>üçØ Miodobranie <span class="small" id="harvCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="harvDate" type="date" class="input">
          <input id="harvType" type="text" class="input" placeholder="Rodzaj miodu (np. lipowy)">
          <input id="harvKg" type="number" step="0.01" class="input" placeholder="Ilo≈õƒá (kg)">
        </div>
        <div class="row cols2">
          <button id="harvSaveBtn" class="btn btn-orange">ZAPISZ MIODOBRANIE</button>
          <button id="harvClearBtn" class="btn btn-ghost">WYCZY≈öƒÜ EDYCJƒò</button>
        </div>
        <div id="harvList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <div class="card" style="border-left:6px solid var(--slate); margin-top:20px;">
        <div class="muted">ZARZƒÑDZANIE ULEM</div>
        <div class="row mt-2">
           <button id="archiveHiveBtn" class="btn btn-slate w-full">üì¶ ARCHIWIZUJ / PO≈ÅƒÑCZ</button>
        </div>
        <div class="small mt-2">U≈ºyj tej opcji, gdy ≈ÇƒÖczysz rodziny lub likwidujesz ul. Ul zostanie oznaczony jako nieaktywny, ale zachowasz jego historiƒô.</div>
    </div>

  </section>

  <section id="viewCalendar" class="hidden">
    <div class="flex gap-2 items-center mb-2">
      <div class="pill">üìÖ KALENDARZ</div>
      <select id="calYear" class="input" style="max-width:200px"></select>
    </div>
    <div id="calendarGrid" class="grid cols-2" style="gap:10px"></div>
  </section>

  <section id="viewFinance" class="hidden">
    <div class="card text-center" style="border-top:5px solid var(--emerald);margin-bottom:16px">
      <div class="muted">BILANS</div>
      <div id="finBalance" style="font-weight:700;margin:6px 0;font-size:30px">0.00 PLN</div>
      <div class="flex justify-between" style="font-size:10px;font-weight:700">
        <span style="color:var(--success)">PRZYCH√ìD: <span id="finInc">0</span></span>
        <span style="color:var(--danger)">WYDATEK: <span id="finExp">0</span></span>
      </div>
    </div>

    <div class="card mb-2">
      <div class="row cols2">
        <select id="finType" class="input">
          <option value="expense">üìâ WYDATEK</option>
          <option value="income">üìà PRZYCH√ìD</option>
        </select>
        <input id="finDate" type="date" class="input">
      </div>
      <div class="row cols2">
        <input id="finAmount" type="number" placeholder="PLN" class="input">
        <input id="finDesc" type="text" placeholder="Opis (np. Cukier)" class="input">
      </div>
      <div class="mt-2">
        <button id="addFinBtn" class="btn btn-green w-full">DODAJ</button>
        <div class="small mt-2">Pozycje mo≈ºesz usuwaƒá.</div>
      </div>
    </div>

    <div id="finList" class="grid" style="gap:10px"></div>
  </section>

  <section id="viewInventory" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--slate)">
      <h3 style="margin:0 0 10px 0;font-weight:700">Magazyn (historia stan√≥w)</h3>

      <div class="row cols2">
        <select id="invItemSel" class="input"></select>
        <input id="invNewName" type="text" placeholder="lub wpisz nowy produkt (np. Cukier)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveDate" type="date" class="input">
        <input id="invMoveDelta" type="number" step="0.01" placeholder="+ / ‚àí ilo≈õƒá (np. 25 lub -10)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveNote" type="text" placeholder="Pow√≥d (np. zakup, karmienie, produkcja)" class="input">
        <button id="invAddMoveBtn" class="btn btn-slate">DODAJ RUCH</button>
      </div>
      <div class="small mt-2">
        Ka≈ºdy wpis to ruch magazynowy z datƒÖ. Dziƒôki temu mo≈ºesz sprawdziƒá stan na dowolny dzie≈Ñ.
      </div>
    </div>

    <div class="card mb-2" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">SPRAWD≈π STAN NA DZIE≈É</div>
      <div class="row cols2">
        <select id="invQueryItem" class="input"></select>
        <input id="invQueryDate" type="date" class="input">
      </div>
      <button id="invQueryBtn" class="btn btn-blue w-full mt-2">POKA≈ª</button>
      <div id="invQueryResult" class="mt-2"></div>
    </div>

    <div class="card">
      <div class="muted mb-2">AKTUALNE STANY</div>
      <div id="invList" class="grid" style="gap:10px"></div>
    </div>
  </section>

  <section id="viewKnowledge" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--purple)">
      <h3 style="margin:0 0 10px 0;font-weight:700">Wiedza (tematy)</h3>
      <div class="row cols2">
        <input id="knowNewTopic" type="text" placeholder="Nowy temat (np. Odk≈Çady)" class="input">
        <button id="addTopicBtn" class="btn" style="background:var(--purple)">DODAJ TEMAT</button>
      </div>
      <div class="row cols2">
        <select id="knowTopic" class="input"></select>
        <input id="knowTitle" type="text" placeholder="Tytu≈Ç notatki" class="input">
      </div>
      <textarea id="knowBody" placeholder="Tre≈õƒá..." class="input" style="height:90px"></textarea>
      <button id="addKnowBtn" class="btn w-full mt-2" style="background:var(--purple)">ZAPISZ NOTATKƒò</button>
      <div class="small mt-2">Notatki sƒÖ pogrupowane wg tematu. Pozycje mo≈ºesz usuwaƒá.</div>
    </div>
    <div id="knowList" class="grid" style="gap:10px"></div>
  </section>
</main>


<div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="confirm-head">
      <div id="confirmTitle" class="confirm-title">POTWIERD≈π</div>
      <button id="confirmClose" class="btn btn-ghost" style="padding:6px 10px">‚úï</button>
    </div>
    <div class="confirm-body">
      <div id="confirmMessage" style="font-weight:700;font-size:16px"></div>
      <div id="confirmHint" class="small" style="margin-top:6px">Tej operacji nie da siƒô cofnƒÖƒá.</div>
    </div>
    <div class="confirm-foot">
      <button id="confirmCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="confirmOk" class="btn btn-red" style="padding:10px 14px">TAK, USU≈É</button>
    </div>
  </div>
</div>

<div id="addHiveOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true">
    <div class="confirm-head">
      <div class="confirm-title">NOWY UL</div>
      <button id="addHiveClose" class="btn btn-ghost" style="padding:6px 10px">‚úï</button>
    </div>
    <div class="confirm-body">
      <div class="row cols2">
        <input id="newHiveLabel" class="input" placeholder="Numer / nazwa (np. 12)">
        <input id="newHiveYear" class="input" type="number" placeholder="Rok">
      </div>
      <input id="newHivePlace" class="input mt-2" placeholder="Po≈Ço≈ºenie (np. RzƒÖd 1)">
      <select id="newHiveType" class="input mt-2">
        <option value="rodzina">Rodzina</option>
        <option value="odklad">Odk≈Çad</option>
      </select>
    </div>
    <div class="confirm-foot">
      <button id="addHiveCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="addHiveSave" class="btn btn-green" style="padding:10px 14px">ZAPISZ UL</button>
    </div>
  </div>
</div>

<div id="archiveHiveOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true">
    <div class="confirm-head">
      <div class="confirm-title">ARCHIWIZACJA / ≈ÅƒÑCZENIE</div>
      <button id="archiveHiveClose" class="btn btn-ghost" style="padding:6px 10px">‚úï</button>
    </div>
    <div class="confirm-body">
      <div style="font-weight:700; margin-bottom:10px;">Z jakim ulem ≈ÇƒÖczysz tƒô rodzinƒô?</div>
      <input id="archiveReason" class="input" placeholder="Np. Po≈ÇƒÖczono z ulem nr 5">
      <div class="small mt-2">Ul zostanie oznaczony jako "nieaktywny" i ukryty na g≈Ç√≥wnym widoku (bƒôdzie dostƒôpny w filtrze "Archiwum").</div>
    </div>
    <div class="confirm-foot">
      <button id="archiveHiveCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="archiveHiveConfirm" class="btn btn-blue" style="padding:10px 14px">ARCHIWIZUJ</button>
    </div>
  </div>
</div>


<script>
(() => {
  "use strict";

  /* ===== Helpers ===== */
  const $ = (id) => document.getElementById(id);

  // FIX: crypto mo≈ºe nie istnieƒá (wtedy "crypto && ..." potrafi rzuciƒá ReferenceError)
  const uid = () => (window.crypto && window.crypto.randomUUID)
    ? window.crypto.randomUUID()
    : (Date.now().toString(36) + Math.random().toString(36).slice(2));

  const esc = (s) =>
    String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");


  /* ===== Confirm (bez window.confirm) ===== */
  function confirmDialog({ title="POTWIERD≈π", message="", confirmText="TAK", confirmClass="btn-blue", hint="Tej operacji nie da siƒô cofnƒÖƒá." } = {}){
    return new Promise((resolve) => {
      const ov = $("confirmOverlay");
      const tt = $("confirmTitle");
      const msg = $("confirmMessage");
      const hintEl = $("confirmHint");
      const ok = $("confirmOk");
      const cancel = $("confirmCancel");
      const close = $("confirmClose");

      tt.textContent = title;
      msg.textContent = message;
      hintEl.textContent = hint || "";

      // ustaw przycisk OK
      ok.textContent = confirmText;
      ok.classList.remove("btn-blue","btn-green","btn-red","btn-slate","btn-orange");
      ok.classList.add(confirmClass);

      // poka≈º
      ov.classList.add("show");
      ov.setAttribute("aria-hidden","false");

      const finish = (val) => {
        // sprzƒÖtanie listener√≥w
        ok.onclick = null;
        cancel.onclick = null;
        close.onclick = null;
        ov.onclick = null;

        ov.classList.remove("show");
        ov.setAttribute("aria-hidden","true");
        resolve(val);
      };

      ok.onclick = () => finish(true);
      cancel.onclick = () => finish(false);
      close.onclick = () => finish(false);
      ov.onclick = (e) => { if (e.target === ov) finish(false); };
    });
  }

  function confirmDelete(message){
    return confirmDialog({ title:"USUWANIE", message, confirmText:"TAK, USU≈É", confirmClass:"btn-red", hint:"Tej operacji nie da siƒô cofnƒÖƒá." });
  }

  const todayISO = () => new Date().toISOString().slice(0,10);

  /* ===== UI toast (zamiast alert√≥w przeglƒÖdarki) ===== */
  let __toastTimer = null;
  function notify(msg){
    const el = $("toast");
    if (!el) { console.warn(msg); return; }
    el.textContent = String(msg || "");
    el.classList.add("show");
    if (__toastTimer) clearTimeout(__toastTimer);
    __toastTimer = setTimeout(()=> el.classList.remove("show"), 2400);
  }

  const thisYear = new Date().getFullYear();

  const isoToPL = (iso) => {
    if (!iso) return "‚Äî";
    const [y,m,d] = String(iso).split("-");
    if (!y || !m || !d) return iso;
    return `${d}.${m}.${y}`;
  };

  const parseISODate = (iso) => {
    if (!iso) return null;
    const [y,m,d] = String(iso).split("-").map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m-1, d, 12, 0, 0, 0);
  };

  const monthsDiff = (y1,m1,y2,m2) => (y2*12 + (m2-1)) - (y1*12 + (m1-1));

  /* ===== IndexedDB ===== */
  const DB_NAME = "pasiecznik_ultra_db";
  const DB_VER  = 11; // bump: visual refresh + avoid downgrade errors
  let db = null;

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains("data")) d.createObjectStore("data", { keyPath:"key" });
      };
      req.onsuccess = () => { db = req.result; resolve(db); };
      req.onerror = () => reject(req.error);
    });
  }

  function dbGet(key){
    return new Promise((resolve) => {
      const tx = db.transaction("data","readonly");
      const req = tx.objectStore("data").get(key);
      req.onsuccess = () => resolve(req.result ? req.result.value : null);
      req.onerror = () => resolve(null);
    });
  }

  function dbSet(key, value){
    return new Promise((resolve, reject) => {
      const tx = db.transaction("data","readwrite");
      tx.objectStore("data").put({ key, value });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /* ===== State ===== */
  const State = {
    view: "hives",
    currentHive: null,

    hives: [],
    reviews: [],
    queens: [],
    feedings: [],
    treatments: [],
    harvests: [],

    calendar: {},
    finance: [],
    invItems: [],
    invMoves: [],

    topics: [],
    knowledge: []
  };

  async function loadAll(){
    State.hives     = (await dbGet("hives"))     || [];
    State.reviews   = (await dbGet("reviews"))   || [];
    State.queens    = (await dbGet("queens"))    || [];
    State.feedings  = (await dbGet("feedings"))  || [];
    State.treatments = (await dbGet("treatments")) || [];
    State.harvests  = (await dbGet("harvests"))  || [];
    State.calendar  = (await dbGet("calendar"))  || {};
    State.finance   = (await dbGet("finance"))   || [];
    State.invItems  = (await dbGet("invItems"))  || [];
    State.invMoves  = (await dbGet("invMoves"))  || [];
    State.topics    = (await dbGet("topics"))    || ["Og√≥lne"];
    State.knowledge = (await dbGet("knowledge")) || [];

    if (!State.hives.length){
      State.hives = ["1","2","3"].map(s => ({
        id: s, label: s, place: "", kind: "rodzina", year: thisYear, nextVisitDate: "", isArchived: false, mapX:20, mapY:20
      }));
      await dbSet("hives", State.hives);
    }

    State.hives.forEach(h => {
      if (h.label == null) h.label = h.id;
      if (h.place == null) h.place = "";
      if (h.kind == null) h.kind = "rodzina";
      if (h.year == null) h.year = thisYear;
      if (h.nextVisitDate == null) h.nextVisitDate = "";
      if (h.isArchived == null) h.isArchived = false;
      if (h.mapX == null) h.mapX = 20;
      if (h.mapY == null) h.mapY = 20;
    });
  }

  async function save(key){ await dbSet(key, State[key]); }

  /* ===== Router ===== */
  function hideAll(){
    document.querySelectorAll("main > section").forEach(s => s.classList.add("hidden"));
  }

  function setTitle(){
    const v = State.view;
    $("backBtn").classList.toggle("hidden", v !== "details");
    const map = {
      hives:"PASIECZNIK",
      details:"UL",
      map: "MAPA PASIEKI",
      calendar:"KALENDARZ",
      finance:"FINANSE",
      inventory:"MAGAZYN",
      knowledge:"WIEDZA"
    };
    $("appTitle").textContent =
      (v === "details" && State.currentHive) ? ("UL " + State.currentHive) : (map[v] || "PASIECZNIK");
  }

  function renderView(view, hiveId=null, push=true){
    State.view = view;
    State.currentHive = hiveId;

    hideAll();
    const secId = "view" + view.charAt(0).toUpperCase() + view.slice(1);
    const sec = $(secId);
    if (sec) sec.classList.remove("hidden");
    setTitle();

    if (view === "hives") renderHives();
    if (view === "details") renderDetails();
    if (view === "map") renderMap(); // NOWY WIDOK
    if (view === "calendar") renderCalendar();
    if (view === "finance") renderFinance();
    if (view === "inventory") renderInventory();
    if (view === "knowledge") renderKnowledge();

    if (push){
      const p = new URLSearchParams();
      p.set("v", view);
      if (view === "details" && hiveId) p.set("id", hiveId);
      history.pushState({view, hiveId}, "", "?" + p.toString());
    }
  }

  window.onpopstate = (e) => {
    const st = e.state;
    if (st && st.view){
      renderView(st.view, st.hiveId || null, false);
      return;
    }
    const p = new URLSearchParams(location.search);
    const v = p.get("v") || "hives";
    const id = p.get("id");
    renderView(v, v === "details" ? id : null, false);
  };

  /* ===== MAPA LOGIC (ZOOM & FIT) ===== */
  let mapState = {
      scale: 1,
      translateX: 0,
      translateY: 0
  };

  function renderMap(){
      const surface = $("mapSurface");
      surface.innerHTML = "";
      
      const activeHives = State.hives.filter(h => !h.isArchived);
      
      activeHives.forEach(h => {
          const el = document.createElement("div");
          el.className = "map-hive";
          el.style.left = (h.mapX || 20) + "px";
          el.style.top  = (h.mapY || 20) + "px";
          el.setAttribute("data-id", h.id);

          el.innerHTML = `
            <svg class="hive-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 40 L50 5 L95 40 L90 40 L90 95 L10 95 L10 40 Z" fill="#D9A441" stroke="#7A5C3E" stroke-width="4" stroke-linejoin="round"/>
              <path d="M5 40 L50 5 L95 40" fill="none" stroke="#7A5C3E" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="10" y1="58" x2="90" y2="58" stroke="#7A5C3E" stroke-width="3" opacity="0.3"/>
              <line x1="10" y1="76" x2="90" y2="76" stroke="#7A5C3E" stroke-width="3" opacity="0.3"/>
              <rect x="35" y="80" width="30" height="8" rx="2" fill="#333"/>
            </svg>
            <div class="hive-label">${esc(h.label)}</div>
          `;
          
          initMapDrag(el, h);
          surface.appendChild(el);
      });

      // Init Zoom Logic
      // Check if we already have fit the map
      if(!mapState.fitDone){
         fitMapToContent();
         mapState.fitDone = true;
      } else {
         applyMapTransform();
      }
      
      initMapControls();
  }

  function applyMapTransform(){
      const surface = $("mapSurface");
      surface.style.transform = `translate(${mapState.translateX}px, ${mapState.translateY}px) scale(${mapState.scale})`;
  }
  
  function fitMapToContent(){
      const viewport = $("mapViewport");
      const surface = $("mapSurface");
      const hives = State.hives.filter(h => !h.isArchived);
      
      if(!hives.length) {
          mapState.scale = 1;
          mapState.translateX = 0;
          mapState.translateY = 0;
          applyMapTransform();
          return;
      }
      
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      hives.forEach(h => {
          const x = h.mapX || 20;
          const y = h.mapY || 20;
          if(x < minX) minX = x;
          if(x > maxX) maxX = x;
          if(y < minY) minY = y;
          if(y > maxY) maxY = y;
      });
      
      // Add padding
      const padding = 100;
      
      const contentW = (maxX - minX) + padding*2;
      const contentH = (maxY - minY) + padding*2;
      const viewW = viewport.clientWidth;
      const viewH = viewport.clientHeight;
      
      // Prevent division by zero
      if(contentW <= 0 || contentH <= 0) return;

      const scaleX = viewW / contentW;
      const scaleY = viewH / contentH;
      const scale = Math.min(scaleX, scaleY, 1) * 0.9; 
      
      mapState.scale = scale;
      // Center logic: We want (minX - padding) to be at 0 visually, then centered
      mapState.translateX = -minX * scale + (viewW - (maxX - minX)*scale)/2; 
      mapState.translateY = -minY * scale + (viewH - (maxY - minY)*scale)/2;
      
      applyMapTransform();
  }
  
  function initMapControls(){
      const viewport = $("mapViewport");
      
      // Re-attach listeners to avoid duplicates
      // Simple Hack: clone node to remove listeners
      const newViewport = viewport.cloneNode(true);
      viewport.parentNode.replaceChild(newViewport, viewport);
      
      // Re-select after replace
      const vp = $("mapViewport");
      // We need to re-render hives into new viewport
      // Actually easier to just attach listeners once, but here simplified for "renderMap" structure
      
      // Let's attach listeners to mapContainer instead which is stable
      const container = $("mapContainer");
      // Remove old listeners? Hard.
      // Better strategy: check if initialized
      if(container.dataset.init) return; 
      container.dataset.init = "true";

      const surface = $("mapSurface");

      let startDist = 0;
      let startScale = 1;
      let startX = 0, startY = 0;
      let isPanning = false;

      const vPort = $("mapViewport");

      // --- PINCH TO ZOOM & PAN ---
      vPort.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
              e.preventDefault();
              startDist = Math.hypot(
                  e.touches[0].pageX - e.touches[1].pageX,
                  e.touches[0].pageY - e.touches[1].pageY
              );
              startScale = mapState.scale;
          } else if(e.touches.length === 1) {
               // Check if target is not a hive (hive has its own listener)
               if(!e.target.closest('.map-hive')){
                   isPanning = true;
                   startX = e.touches[0].pageX - mapState.translateX;
                   startY = e.touches[0].pageY - mapState.translateY;
               }
          }
      }, {passive: false});

      vPort.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2) {
              e.preventDefault();
              const dist = Math.hypot(
                  e.touches[0].pageX - e.touches[1].pageX,
                  e.touches[0].pageY - e.touches[1].pageY
              );
              if (startDist > 0) {
                  const newScale = startScale * (dist / startDist);
                  mapState.scale = Math.max(0.1, Math.min(newScale, 3));
                  applyMapTransform();
              }
          } else if(isPanning && e.touches.length === 1) {
              e.preventDefault();
              mapState.translateX = e.touches[0].pageX - startX;
              mapState.translateY = e.touches[0].pageY - startY;
              applyMapTransform();
          }
      }, {passive: false});
      
      vPort.addEventListener('touchend', ()=>{ isPanning = false; });
      
      // Mouse Pan
      let isMousePanning = false;
      let mStartX=0, mStartY=0;
      vPort.addEventListener('mousedown', (e)=>{
          if(!e.target.closest('.map-hive')){
              isMousePanning=true;
              mStartX = e.clientX - mapState.translateX;
              mStartY = e.clientY - mapState.translateY;
              vPort.style.cursor = 'grabbing';
          }
      });
      window.addEventListener('mousemove', (e)=>{
          if(!isMousePanning) return;
          e.preventDefault();
          mapState.translateX = e.clientX - mStartX;
          mapState.translateY = e.clientY - mStartY;
          applyMapTransform();
      });
      window.addEventListener('mouseup', ()=>{
          isMousePanning=false;
          vPort.style.cursor = 'grab';
      });


      // Mouse Wheel Zoom
      vPort.addEventListener('wheel', (e) => {
         if(e.ctrlKey){
             e.preventDefault();
             const delta = -e.deltaY * 0.001;
             mapState.scale = Math.max(0.1, Math.min(mapState.scale + delta, 3));
             applyMapTransform();
         }
      }, {passive:false});
      
      // Fit Button
      $("btnFitMap").onclick = fitMapToContent;
  }

  function initMapDrag(el, hiveData){
      let startX, startY, initialLeft, initialTop;
      let isDragging = false;
      let moved = false;

      // Mouse/Touch Start
      const onStart = (e) => {
          // If 2 fingers, ignore drag
          if(e.touches && e.touches.length > 1) return;
          
          // Stop propagation so map panning doesn't start
          e.stopPropagation();

          if(e.type === 'touchstart') {
              // e.preventDefault(); // Don't prevent default immediately, might be a tap
          }
          
          isDragging = true;
          moved = false;
          
          const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
          
          startX = clientX;
          startY = clientY;
          initialLeft = parseFloat(el.style.left) || 0;
          initialTop  = parseFloat(el.style.top) || 0;
          
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onEnd);
          document.addEventListener('touchmove', onMove, {passive:false});
          document.addEventListener('touchend', onEnd);
      };

      const onMove = (e) => {
          if(!isDragging) return;
          
          const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
          
          // Sensitivity check (10px threshold)
          if(Math.abs(clientX - startX) > 10 || Math.abs(clientY - startY) > 10) {
              moved = true;
              if(e.cancelable) e.preventDefault(); // Now we are sure it's a drag
              el.classList.add("dragging");
          }

          if (moved) {
              const dx = (clientX - startX) / mapState.scale;
              const dy = (clientY - startY) / mapState.scale;
              
              el.style.left = (initialLeft + dx) + "px";
              el.style.top  = (initialTop + dy) + "px";
          }
      };

      const onEnd = async () => {
          isDragging = false;
          el.classList.remove("dragging");
          
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onEnd);
          document.removeEventListener('touchmove', onMove);
          document.removeEventListener('touchend', onEnd);
          
          if(!moved) {
              // TAP
              renderView("details", hiveData.id, true);
          } else {
              // DRAG END
              hiveData.mapX = parseFloat(el.style.left);
              hiveData.mapY = parseFloat(el.style.top);
              await save("hives");
          }
      };

      el.addEventListener('mousedown', onStart);
      el.addEventListener('touchstart', onStart, {passive:false});
  }


  /* ===== Computed ===== */
  function lastReviewForHive(hiveId){
    const rs = State.reviews
      .filter(r => r.hiveId === hiveId && r.visitDate)
      .sort((a,b) => (b.visitDate||"").localeCompare(a.visitDate||"") || (b.ts||0)-(a.ts||0));
    return rs[0] || null;
  }

  function lastReviewDateForHive(hiveId){
    return lastReviewForHive(hiveId)?.visitDate || "";
  }

  function needsReview(hive){
    const t = todayISO();
    if (hive.nextVisitDate) return hive.nextVisitDate <= t;
    const last = lastReviewDateForHive(hive.id);
    if (!last) return true;
    const lastDt = parseISODate(last);
    const now = parseISODate(t);
    const diffDays = Math.floor((now - lastDt) / (1000*60*60*24));
    return diffDays >= 6;
  }

  function currentQueenForHive(hiveId){
    const qs = State.queens.filter(q => q.hiveId === hiveId);
    const current = qs.find(q => q.isCurrent);
    if (current) return current;
    return qs.sort((a,b)=>(b.ts||0)-(a.ts||0))[0] || null;
  }

  function queenNeedsChange(hiveId){
    const q = currentQueenForHive(hiveId);
    if (!q || !q.year || !q.month) return false;
    const now = new Date();
    const ageM = monthsDiff(Number(q.year), Number(q.month), now.getFullYear(), now.getMonth()+1);
    return ageM >= 24;
  }

  /* ===== Filters ===== */
  const Filters = { review:false, queen:false, archived:false };
  function applyFilterFlags(btn, isOn, style){
    btn.classList.toggle("active", !!isOn);
    if (style==="red") btn.classList.toggle("active-red", !!isOn);
    if (style==="slate") btn.classList.toggle("active-slate", !!isOn);
  }
  function renderFilterButtons(){
    applyFilterFlags($("fltReviewBtn"), Filters.review);
    applyFilterFlags($("fltQueenBtn"), Filters.queen, "red");
    applyFilterFlags($("fltArchivedBtn"), Filters.archived, "slate");
  }
  function filterHives(list){
    let out = [...list];
    
    // ARCHIVE LOGIC
    if (Filters.archived) {
        out = out.filter(h => h.isArchived === true);
    } else {
        out = out.filter(h => !h.isArchived); // show only active by default
    }

    if (Filters.review) out = out.filter(h => needsReview(h));
    if (Filters.queen) out = out.filter(h => queenNeedsChange(h.id));
    return out;
  }

  /* ===== Render: Hives ===== */
  function renderHives(){
    renderFilterButtons();
    const grid = $("hivesGrid");
    grid.innerHTML = "";

    const sorted = [...State.hives].sort((a,b) =>
      String(a.label).localeCompare(String(b.label), undefined, {numeric:true})
    );
    const filtered = filterHives(sorted);

    filtered.forEach(h => {
      const due = needsReview(h);
      const lastRev = lastReviewDateForHive(h.id);

      const q = currentQueenForHive(h.id);
      const qChange = queenNeedsChange(h.id);
      const now = new Date();
      const qAgeM = (q && q.year && q.month)
        ? monthsDiff(Number(q.year), Number(q.month), now.getFullYear(), now.getMonth()+1)
        : null;
      const qName = (q && q.name) ? String(q.name) : "brak";
      
      const isArch = !!h.isArchived;

      // LOGIKA FORMATOWANIA WIEKU (LATA + MIESIƒÑCE)
      let ageStr = "";
      if (qAgeM !== null) {
          if (qAgeM < 12) {
              ageStr = ` ‚Ä¢ ${qAgeM} mies.`;
          } else {
              const y = Math.floor(qAgeM / 12);
              const m = qAgeM % 12;
              ageStr = ` ‚Ä¢ ${y} l. ${m} mies.`;
          }
      }

      const el = document.createElement("div");
      el.className = "card hive-card" + (isArch ? " archived" : "");
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div style="font-size:22px;font-weight:700">${esc(h.label)} ${isArch ? "(ARCH)" : ""}</div>
            <div class="small" style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
              <span class="pill">${h.kind==="odklad"?"Odk≈Çad":"Rodzina"} ${esc(h.year)}</span>
              ${h.place ? `<span class="pill">üìç ${esc(h.place)}</span>` : ``}
              ${
                h.nextVisitDate && !isArch
                  ? `<span class="pill" style="border-color:${due?'#fecaca':'var(--border)'}">‚è≠ Nastƒôpny przeglƒÖd: ${esc(isoToPL(h.nextVisitDate))}</span>`
                  : (due && !isArch ? `<span class="pill" style="border-color:#fecaca">‚è≠ Nastƒôpny przeglƒÖd: BRAK</span>` : ``)
              }
              <span class="pill" style="border-color:${qChange?'#fecaca':'var(--border)'}">üëë ${esc(qName)}${ageStr}</span>
              ${qChange && !isArch ? `<span class="pill" style="border-color:#fecaca">üëë ‚ö† DO WYMIANY</span>` : ``}
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">Ostatni przeglƒÖd</div>
            <div style="font-weight:700">${lastRev ? isoToPL(lastRev) : "‚Äî"}</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:12px">
          ${isArch 
            ? `<div style="color:var(--slate);font-weight:700">üóÑÔ∏è ZARCHIWIZOWANY</div>`
            : `<div class="${due?'text-alert':''}" style="margin-top:6px;font-weight:700">${due ? "üîé DO PRZEGLƒÑDU" : "‚úÖ OK"}</div>`
          }
        </div>
      `;
      el.addEventListener("click", () => renderView("details", h.id, true));
      grid.appendChild(el);
    });

    if (!filtered.length){
      const empty = document.createElement("div");
      empty.className = "card text-center";
      empty.innerHTML = `
        <div style="font-weight:700">${Filters.archived ? "Brak uli w archiwum." : "Brak aktywnych uli."}</div>
        <div class="small mt-2">${Filters.archived ? "" : "Dodaj ul przyciskiem + UL."}</div>
      `;
      grid.appendChild(empty);
    }
  }

  /* ===== Details ===== */
  let editReviewId = null;
  let editFeedId = null;
  let editTreatId = null;
  let editQueenId = null;
  let editHarvId = null;

  function renderDetails(){
    const hiveId = State.currentHive;
    const hive = State.hives.find(h => h.id === hiveId);
    if (!hive){ renderView("hives", null, true); return; }

    $("detailsTitle").textContent = `${hive.label} ‚Ä¢ ${hive.kind==="odklad"?"Odk≈Çad":"Rodzina"} ‚Ä¢ ${hive.year}`;

    $("hLabel").value = hive.label || hive.id || "";
    $("hPlace").value = hive.place || "";
    $("hType").value  = hive.kind || "rodzina";
    $("hYear").value  = hive.year || thisYear;
    $("hNextVisit").value = hive.nextVisitDate
