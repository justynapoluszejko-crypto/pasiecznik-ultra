<!--
PASIECZNIK ULTRA
¬© 2025 Justyna Poluszejko-K≈Çoda

Kod ≈∫r√≥d≈Çowy objƒôty prawami autorskimi.
Repozytorium publiczne wy≈ÇƒÖcznie w celach demonstracyjnych.
Zasady u≈ºycia okre≈õla plik LICENSE.
-->
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Pasiecznik ULTRA PRO</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ca8a04">
  <style>
    :root{
      --primary:#ca8a04; --primary-dark:#854d0e;
      --bg:#f1f5f9; --white:#fff; --text:#0f172a;
      --danger:#dc2626; --success:#16a34a; --blue:#2563eb;
      --slate:#334155; --purple:#7e22ce; --emerald:#059669; --orange:#f97316;
      --border:#e2e8f0;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:90px}
    .header{background:var(--primary);color:#fff;padding:12px;position:sticky;top:0;z-index:50;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .header-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .header-title{font-weight:1000;text-transform:uppercase;letter-spacing:1px;font-size:1.05rem}
    .nav-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:5px;scrollbar-width:none}
    .nav-scroll::-webkit-scrollbar{display:none}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media (min-width:640px){.grid-hives{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:768px){.grid-hives{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:1024px){.grid-hives{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:639px){.grid-hives{grid-template-columns:repeat(2,1fr)}}
    .btn{border:none;padding:8px 16px;border-radius:10px;font-weight:1000;cursor:pointer;text-transform:uppercase;font-size:.75rem;transition:.2s;color:#fff;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
    .btn:active{transform:scale(.96)}
    .btn-nav{background:var(--primary-dark);border:1px solid rgba(255,255,255,.18)}
    .btn-green{background:var(--success)}
    .btn-red{background:var(--danger)}
    .btn-blue{background:var(--blue)}
    .btn-slate{background:var(--slate)}
    .btn-orange{background:var(--orange)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn-ghost:active{transform:scale(.98)}
    .btn-chip{background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.12);padding:8px 10px}
    .btn-chip.active{background:var(--blue)}
    .btn-chip.active-red{background:var(--danger)}
    .card{background:var(--white);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);border:1px solid var(--border)}
    .input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;box-sizing:border-box;background:#fff}
    .input:focus{outline:2px solid var(--primary);border-color:transparent}
    .hidden{display:none!important}
    .flex{display:flex}
    .gap-2{gap:8px}
    .gap-3{gap:12px}
    .justify-between{justify-content:space-between}
    .items-center{align-items:center}
    .w-full{width:100%}
    .text-center{text-align:center}
    .mb-2{margin-bottom:8px}
    .mt-2{margin-top:8px}
    .mt-3{margin-top:12px}
    .hive-card{border-bottom:6px solid var(--primary);cursor:pointer;transition:transform .2s}
    .hive-card:hover{transform:translateY(-2px)}
    .text-alert{color:var(--danger);font-weight:1000;animation:blink 2s infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:.55}100%{opacity:1}}
    details{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff}
    details>summary{background:#f8fafc;padding:12px;font-weight:1000;cursor:pointer;list-style:none;font-size:.8rem;text-transform:uppercase;color:#475569;display:flex;justify-content:space-between;align-items:center}
    details[open]>summary{background:#e2e8f0}
    .details-content{padding:12px;border-top:1px solid var(--border)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:1000;font-size:11px;border:1px solid var(--border);background:#fff}
    .muted{color:#64748b;font-weight:1000;font-size:11px;text-transform:uppercase;letter-spacing:1px}
    .small{font-size:12px;color:#64748b;font-weight:700}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:600px){.row.cols2{grid-template-columns:1fr 1fr}}
    .tag-danger{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:1000;font-size:11px;border:1px solid #fecaca;background:#fff;color:var(--danger)}
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="flex items-center gap-2">
      <button id="backBtn" class="btn btn-nav hidden">‚¨Ö</button>
      <div id="appTitle" class="header-title">PASIECZNIK ULTRA</div>
    </div>
    <div class="flex gap-2">
      <button id="exportBtn" class="btn btn-green">‚¨á KOPIA</button>
      <label class="btn btn-slate" style="cursor:pointer">
        ‚¨Ü IMPORT
        <input id="importFile" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>

  <div class="nav-scroll" id="topNav">
    <button data-view="hives" class="btn btn-nav">üêù Pasieka</button>
    <button data-view="calendar" class="btn btn-nav" style="background:#4f46e5">üìÖ Kalendarz</button>
    <button data-view="finance" class="btn btn-nav" style="background:var(--emerald)">üí∞ Finanse</button>
    <button data-view="inventory" class="btn btn-nav" style="background:var(--slate)">üì¶ Magazyn</button>
    <button data-view="knowledge" class="btn btn-nav" style="background:var(--purple)">üß† Wiedza</button>
    <button id="addHiveBtn" class="btn btn-green">+ UL</button>
  </div>
</header>

<main class="container">
  <!-- PASIEKA -->
  <section id="viewHives" class="grid">
    <div class="card" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">FILTRY EKRANU G≈Å√ìWNEGO</div>
      <div class="flex gap-2" style="flex-wrap:wrap">
        <button id="fltReviewBtn" class="btn btn-chip">üîé DO PRZEGLƒÑDU</button>
        <button id="fltQueenBtn" class="btn btn-chip">üëë WYMIENIƒÜ MATKƒò</button>
        <button id="fltClearBtn" class="btn btn-ghost" style="padding:8px 10px">WYCZY≈öƒÜ</button>
      </div>
      <div class="small mt-2">
        ‚ÄûDo przeglƒÖdu‚Äù = ul z <b>terminem nastƒôpnego przeglƒÖdu</b> na dzi≈õ / wstecz, albo (je≈õli brak terminu) ostatni przeglƒÖd starszy ni≈º <b>6 dni</b>.
        ‚ÄûWymieniƒá matkƒô‚Äù = <b>aktualna</b> matka ma <b>‚â• 24 miesiƒÖce</b>.
      </div>
    </div>
    <div id="hivesGrid" class="grid grid-hives"></div>
  </section>

  <!-- SZCZEG√ì≈ÅY ULA -->
  <section id="viewDetails" class="hidden grid">
    <div class="card" style="border-left:6px solid var(--primary)">
      <div class="muted">UL</div>
      <div id="detailsTitle" style="font-weight:1000;font-size:18px;margin-top:6px"></div>
      <div class="hr"></div>

      <!-- Metadane -->
      <details open>
        <summary>METADANE <span class="small">edytuj</span></summary>
        <div class="details-content">
          <div class="row cols2">
            <input id="hLabel" class="input" type="text" placeholder="Numer / nazwa ula (np. 12, A1)">
            <input id="hPlace" class="input" type="text" placeholder="Po≈Ço≈ºenie (np. RzƒÖd 2 / 3 od lewej)">
          </div>
          <div class="row cols2 mt-2">
            <select id="hType" class="input">
              <option value="rodzina">Rodzina</option>
              <option value="odklad">Odk≈Çad</option>
            </select>
            <input id="hYear" class="input" type="number" placeholder="Rok (np. 2025)">
          </div>
          <div class="row cols2 mt-2">
            <input id="hNextVisit" class="input" type="date">
            <button id="saveHiveMetaBtn" class="btn btn-blue">ZAPISZ</button>
          </div>
          <div class="small mt-2">
            Pole <b>Nastƒôpny przeglƒÖd</b> mo≈ºesz ustawiƒá rƒôcznie tutaj, albo przy dodawaniu przeglƒÖdu.
          </div>
        </div>
      </details>

      <!-- Matki -->
      <details open>
        <summary>MATKI <span class="small" id="qCountPill">0</span></summary>
        <div class="details-content">
          <div id="qCurrentBox" class="card" style="padding:12px;border-left:4px solid var(--orange);margin-bottom:12px"></div>

          <div class="card" style="padding:12px;border-left:4px solid var(--purple);margin-bottom:12px">
            <div class="muted">DODAJ / EDYTUJ WPIS MATKI</div>
            <input type="hidden" id="qEditId" value="">

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Rocznik (rok)</div>
                <input id="qYear" class="input" type="number" placeholder="np. 2024">
              </div>
              <div>
                <div class="small mb-2">MiesiƒÖc</div>
                <select id="qMonth" class="input">
                  <option value="">‚Äî</option>
                  <option value="1">01</option><option value="2">02</option><option value="3">03</option><option value="4">04</option>
                  <option value="5">05</option><option value="6">06</option><option value="7">07</option><option value="8">08</option>
                  <option value="9">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                </select>
              </div>
            </div>

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Nazwa matki</div>
                <input id="qName" class="input" type="text" placeholder="np. Mira / 24-01 / w≈Çasna nazwa">
              </div>
              <div>
                <div class="small mb-2">Typ unasienniania</div>
                <input id="qInsem" class="input" type="text" placeholder="np. naturalne / sztuczne / NU / AI">
              </div>
            </div>

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Linia / hodowca</div>
                <input id="qLine" class="input" type="text" placeholder="np. linia X / hodowca Y">
              </div>
              <div>
                <div class="small mb-2">Kolor opalitki (lub brak)</div>
                <input id="qOpalit" class="input" type="text" placeholder="np. niebieska / bia≈Ça / brak">
              </div>
            </div>

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">≈Åagodno≈õƒá</div>
                <input id="qGentle" class="input" type="text" placeholder="np. bardzo ≈Çagodne / ≈õrednie / ostre">
              </div>
              <div class="flex items-center gap-2" style="margin-top:22px">
                <input id="qSetCurrent" type="checkbox">
                <label for="qSetCurrent" style="font-weight:1000">Ustaw jako aktualnƒÖ</label>
              </div>
            </div>

            <div class="mt-2">
              <div class="small mb-2">Wolna notatka</div>
              <textarea id="qNote" class="input" style="height:90px" placeholder="Wszystko dodatkowe (zostaje w wolnej notatce)"></textarea>
            </div>

            <div class="flex gap-2 mt-2" style="flex-wrap:wrap">
              <button id="qSaveBtn" class="btn" style="background:var(--purple)">ZAPISZ MATKƒò</button>
              <button id="qCancelBtn" class="btn btn-ghost" style="padding:8px 12px">ANULUJ EDYCJƒò</button>
            </div>
          </div>

          <div id="qList" class="grid" style="gap:10px"></div>
        </div>
      </details>

      <!-- Karmienie -->
      <details open>
        <summary>KARMIENIE <span class="small" id="feedCountPill">0</span></summary>
        <div class="details-content">

          <div class="card" style="padding:12px;border-left:4px solid var(--orange);margin-bottom:12px">
            <div class="muted">DODAJ / EDYTUJ KARMIENIE</div>

            <input type="hidden" id="feedEditId" value="">

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Data</div>
                <input id="feedDate" class="input" type="date">
              </div>
              <div>
                <div class="small mb-2">Rodzaj pokarmu</div>
                <input id="feedType" class="input" type="text" placeholder="np. syrop 3:2 / ciasto / inwert / Apifonda">
              </div>
            </div>

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Ilo≈õƒá</div>
                <input id="feedAmount" class="input" type="number" step="0.01" placeholder="np. 2.5">
              </div>
              <div>
                <div class="small mb-2">Jednostka</div>
                <select id="feedUnit" class="input">
                  <option value="kg">kg</option>
                  <option value="l">l</option>
                </select>
              </div>
            </div>

            <div class="flex gap-2 mt-2" style="flex-wrap:wrap">
              <button id="feedSaveBtn" class="btn btn-orange">ZAPISZ KARMIENIE</button>
              <button id="feedCancelBtn" class="btn btn-ghost" style="padding:8px 12px">ANULUJ EDYCJƒò</button>
            </div>

            <div class="small mt-2">Wpisy mo≈ºesz dowolnie edytowaƒá i usuwaƒá.</div>
          </div>

          <div id="feedList" class="grid" style="gap:10px"></div>
        </div>
      </details>

      <!-- PrzeglƒÖdy -->
      <details open>
        <summary>PRZEGLƒÑDY <span class="small" id="revCountPill">0</span></summary>
        <div class="details-content">

          <div class="card" style="padding:12px;border-left:4px solid var(--blue);margin-bottom:12px">
            <div class="muted">DODAJ / EDYTUJ PRZEGLƒÑD</div>

            <input type="hidden" id="revEditId" value="">

            <div class="row cols2 mt-2">
              <div>
                <div class="small mb-2">Data przeglƒÖdu</div>
                <input id="revDate" class="input" type="date">
              </div>
              <div>
                <div class="small mb-2">Nastƒôpny przeglƒÖd (konkretny termin)</div>
                <input id="revNextDate" class="input" type="date">
              </div>
            </div>

            <div class="mt-2">
              <div class="small mb-2">Notatka</div>
              <textarea id="revNote" class="input" style="height:90px" placeholder="Co by≈Ço zrobione? Co zauwa≈ºy≈Ça≈õ?"></textarea>
            </div>

            <div class="flex gap-2 mt-2" style="flex-wrap:wrap">
              <button id="revSaveBtn" class="btn btn-green">ZAPISZ PRZEGLƒÑD</button>
              <button id="revCancelBtn" class="btn btn-ghost" style="padding:8px 12px">ANULUJ EDYCJƒò</button>
            </div>

            <div class="small mt-2">
              Je≈õli wpiszesz <b>Nastƒôpny przeglƒÖd</b>, aplikacja zapisze go te≈º w metadanych ula (pole u g√≥ry).
            </div>
          </div>

          <div id="revList" class="grid" style="gap:10px"></div>
        </div>
      </details>

    </div>
  </section>

  <!-- KALENDARZ -->
  <section id="viewCalendar" class="hidden">
    <div class="flex gap-2 items-center mb-2">
      <div class="pill">üìÖ KALENDARZ</div>
      <select id="calYear" class="input" style="max-width:200px"></select>
    </div>
    <div id="calendarGrid" class="grid cols-2" style="gap:10px"></div>
  </section>

  <!-- FINANSE -->
  <section id="viewFinance" class="hidden">
    <div class="card text-center" style="border-top:5px solid var(--emerald);margin-bottom:16px">
      <div class="muted">BILANS</div>
      <div id="finBalance" style="font-weight:1000;margin:6px 0;font-size:30px">0.00 PLN</div>
      <div class="flex justify-between" style="font-size:10px;font-weight:1000">
        <span style="color:var(--success)">PRZYCH√ìD: <span id="finInc">0</span></span>
        <span style="color:var(--danger)">WYDATEK: <span id="finExp">0</span></span>
      </div>
    </div>

    <div class="card mb-2">
      <div class="row cols2">
        <select id="finType" class="input">
          <option value="expense">üìâ WYDATEK</option>
          <option value="income">üìà PRZYCH√ìD</option>
        </select>
        <input id="finDate" type="date" class="input">
      </div>
      <div class="row cols2">
        <input id="finAmount" type="number" placeholder="PLN" class="input">
        <input id="finDesc" type="text" placeholder="Opis (np. Cukier)" class="input">
      </div>
      <div class="mt-2">
        <button id="addFinBtn" class="btn btn-green w-full">DODAJ</button>
        <div class="small mt-2">Data w finansach jest <b>Twoja (rƒôczna)</b>. Pozycje mo≈ºesz usuwaƒá.</div>
      </div>
    </div>

    <div id="finList" class="grid" style="gap:10px"></div>
  </section>

  <!-- MAGAZYN -->
  <section id="viewInventory" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--slate)">
      <h3 style="margin:0 0 10px 0;font-weight:1000">Magazyn (historia stan√≥w)</h3>

      <div class="row cols2">
        <select id="invItemSel" class="input"></select>
        <input id="invNewName" type="text" placeholder="lub wpisz nowy produkt (np. Cukier)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveDate" type="date" class="input">
        <input id="invMoveDelta" type="number" step="0.01" placeholder="+ / ‚àí ilo≈õƒá (np. 25 lub -10)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveNote" type="text" placeholder="Pow√≥d (np. zakup, karmienie, produkcja)" class="input">
        <button id="invAddMoveBtn" class="btn btn-slate">DODAJ RUCH</button>
      </div>
      <div class="small mt-2">
        Ka≈ºdy wpis to <b>ruch magazynowy</b> z datƒÖ. Dziƒôki temu mo≈ºesz sprawdziƒá stan na dowolny dzie≈Ñ.
      </div>
    </div>

    <div class="card mb-2" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">SPRAWD≈π STAN NA DZIE≈É</div>
      <div class="row cols2">
        <select id="invQueryItem" class="input"></select>
        <input id="invQueryDate" type="date" class="input">
      </div>
      <button id="invQueryBtn" class="btn btn-blue w-full mt-2">POKA≈ª</button>
      <div id="invQueryResult" class="mt-2"></div>
    </div>

    <div class="card">
      <div class="muted mb-2">AKTUALNE STANY</div>
      <div id="invList" class="grid" style="gap:10px"></div>
    </div>
  </section>

  <!-- WIEDZA -->
  <section id="viewKnowledge" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--purple)">
      <h3 style="margin:0 0 10px 0;font-weight:1000">Wiedza (tematy)</h3>
      <div class="row cols2">
        <input id="knowNewTopic" type="text" placeholder="Nowy temat (np. Odk≈Çady)" class="input">
        <button id="addTopicBtn" class="btn" style="background:var(--purple)">DODAJ TEMAT</button>
      </div>
      <div class="row cols2">
        <select id="knowTopic" class="input"></select>
        <input id="knowTitle" type="text" placeholder="Tytu≈Ç notatki" class="input">
      </div>
      <textarea id="knowBody" placeholder="Tre≈õƒá..." class="input" style="height:90px"></textarea>
      <button id="addKnowBtn" class="btn w-full mt-2" style="background:var(--purple)">ZAPISZ NOTATKƒò</button>
      <div class="small mt-2">Notatki sƒÖ pogrupowane wg tematu. Pozycje mo≈ºesz usuwaƒá.</div>
    </div>
    <div id="knowList" class="grid" style="gap:10px"></div>
  </section>
</main>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);
  const uid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2));

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const todayISO = () => new Date().toISOString().slice(0,10);
  const isoToPL = (iso) => {
    if (!iso) return "‚Äî";
    const [y,m,d] = String(iso).split("-");
    if (!y || !m || !d) return iso;
    return `${d}.${m}.${y}`;
  };

  const parseISODate = (iso) => {
    if (!iso) return null;
    const [y,m,d] = String(iso).split("-").map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m-1, d, 12, 0, 0, 0);
  };

  const thisYear = new Date().getFullYear();

  /* ===== IndexedDB ===== */
  const DB_NAME = "pasiecznik_ultra_db";
  const DB_VER  = 6;
  let db = null;

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains("data")) d.createObjectStore("data", { keyPath:"key" });
      };
      req.onsuccess = () => { db = req.result; resolve(db); };
      req.onerror = () => reject(req.error);
    });
  }

  function dbGet(key){
    return new Promise((resolve) => {
      const tx = db.transaction("data","readonly");
      const req = tx.objectStore("data").get(key);
      req.onsuccess = () => resolve(req.result ? req.result.value : null);
      req.onerror = () => resolve(null);
    });
  }

  function dbSet(key, value){
    return new Promise((resolve, reject) => {
      const tx = db.transaction("data","readwrite");
      tx.objectStore("data").put({ key, value });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /* ===== State ===== */
  const State = {
    view: "hives",
    currentHive: null,

    hives: [],
    reviews: [],
    queens: [],
    feedings: [],

    calendar: {},
    finance: [],
    invItems: [],
    invMoves: [],
    topics: [],
    knowledge: []
  };

  async function loadAll(){
    State.hives     = (await dbGet("hives"))     || [];
    State.reviews   = (await dbGet("reviews"))   || [];
    State.queens    = (await dbGet("queens"))    || [];
    State.feedings  = (await dbGet("feedings"))  || [];

    State.calendar  = (await dbGet("calendar"))  || {};
    State.finance   = (await dbGet("finance"))   || [];
    State.invItems  = (await dbGet("invItems"))  || [];
    State.invMoves  = (await dbGet("invMoves"))  || [];
    State.topics    = (await dbGet("topics"))    || ["Og√≥lne"];
    State.knowledge = (await dbGet("knowledge")) || [];

    if (!State.hives.length){
      State.hives = ["1","2","3"].map(s => ({ id:s, label:s, place:"", kind:"rodzina", year:thisYear, nextVisitDate:"" }));
      await dbSet("hives", State.hives);
    }

    State.hives.forEach(h => {
      if (h.label == null) h.label = h.id;
      if (h.place == null) h.place = "";
      if (h.kind == null) h.kind = "rodzina";
      if (h.year == null) h.year = thisYear;
      if (h.nextVisitDate == null) h.nextVisitDate = "";
    });

    State.reviews.forEach(r => {
      if (!r.id) r.id = uid();
      if (r.note == null) r.note = "";
      if (r.visitDate == null) r.visitDate = "";
      if (r.nextVisitDate == null) r.nextVisitDate = "";
      if (r.ts == null) r.ts = Date.now();
    });

    State.queens.forEach(q => {
      if (!q.id) q.id = uid();
      if (q.hiveId == null) q.hiveId = "";
      if (q.year == null) q.year = "";
      if (q.month == null) q.month = "";
      if (q.name == null) q.name = "";
      if (q.insem == null) q.insem = "";
      if (q.line == null) q.line = "";
      if (q.opalit == null) q.opalit = "";
      if (q.gentle == null) q.gentle = "";
      if (q.note == null) q.note = "";
      if (q.isCurrent == null) q.isCurrent = false;
      if (q.ts == null) q.ts = Date.now();
    });

    State.feedings.forEach(f => {
      if (!f.id) f.id = uid();
      if (f.hiveId == null) f.hiveId = "";
      if (f.date == null) f.date = "";
      if (f.type == null) f.type = "";
      if (f.amount == null) f.amount = "";
      if (f.unit == null) f.unit = "kg";
      if (f.ts == null) f.ts = Date.now();
    });
  }

  async function save(key){ await dbSet(key, State[key]); }

  /* ===== Router ===== */
  function hideAll(){ document.querySelectorAll("main > section").forEach(s => s.classList.add("hidden")); }

  function setTitle(){
    const v = State.view;
    $("backBtn").classList.toggle("hidden", v !== "details");
    const map = { hives:"PASIECZNIK", details:"UL", calendar:"KALENDARZ", finance:"FINANSE", inventory:"MAGAZYN", knowledge:"WIEDZA" };
    $("appTitle").textContent = (v === "details" && State.currentHive) ? ("UL " + State.currentHive) : (map[v] || "PASIECZNIK");
  }

  function renderView(view, hiveId=null, push=true){
    State.view = view;
    State.currentHive = hiveId;

    hideAll();
    const secId = "view" + view.charAt(0).toUpperCase() + view.slice(1);
    const sec = $(secId);
    if (sec) sec.classList.remove("hidden");
    setTitle();

    if (view === "hives") renderHives();
    if (view === "details") renderDetails();
    if (view === "calendar") renderCalendar();
    if (view === "finance") renderFinance();
    if (view === "inventory") renderInventory();
    if (view === "knowledge") renderKnowledge();

    if (push){
      const p = new URLSearchParams();
      p.set("v", view);
      if (view === "details" && hiveId) p.set("id", hiveId);
      history.pushState({view, hiveId}, "", "?" + p.toString());
    }
  }

  window.onpopstate = (e) => {
    const st = e.state;
    if (st && st.view){
      renderView(st.view, st.hiveId || null, false);
      return;
    }
    const p = new URLSearchParams(location.search);
    const v = p.get("v") || "hives";
    const id = p.get("id");
    renderView(v, v === "details" ? id : null, false);
  };

  /* ===== Queens logic ===== */
  function getCurrentQueen(hiveId){
    const qs = State.queens.filter(q => q.hiveId === hiveId);
    const cur = qs.find(q => q.isCurrent);
    if (cur) return cur;
    return qs.sort((a,b) => (b.ts||0)-(a.ts||0))[0] || null;
  }

  function queenAgeMonths(q){
    if (!q || !q.year || !q.month) return null;
    const y = Number(q.year), m = Number(q.month);
    if (!Number.isFinite(y) || !Number.isFinite(m) || m<1 || m>12) return null;
    const now = new Date();
    const nowYM = now.getFullYear()*12 + now.getMonth();
    const qYM = y*12 + (m-1);
    return nowYM - qYM;
  }

  function needsQueenReplace(hiveId){
    const q = getCurrentQueen(hiveId);
    const age = queenAgeMonths(q);
    return age != null && age >= 24;
  }

  /* ===== Reviews computed ===== */
  function lastReviewDateForHive(hiveId){
    const rs = State.reviews
      .filter(r => r.hiveId === hiveId && r.visitDate)
      .sort((a,b) => (b.visitDate||"").localeCompare(a.visitDate||"") || (b.ts||0)-(a.ts||0));
    return rs[0]?.visitDate || "";
  }

  function needsReview(hive){
    const t = todayISO();
    if (hive.nextVisitDate) return hive.nextVisitDate <= t;
    const last = lastReviewDateForHive(hive.id);
    if (!last) return true;
    const lastDt = parseISODate(last);
    const now = parseISODate(t);
    const diffDays = Math.floor((now - lastDt) / (1000*60*60*24));
    return diffDays >= 6;
  }

  /* ===== Filters ===== */
  const Filters = { review:false, queen:false };
  function applyFilterFlags(btn, isOn, style){
    btn.classList.toggle("active", !!isOn);
    if (style==="red") btn.classList.toggle("active-red", !!isOn);
  }
  function renderFilterButtons(){
    applyFilterFlags($("fltReviewBtn"), Filters.review);
    applyFilterFlags($("fltQueenBtn"), Filters.queen, "red");
  }
  function filterHives(list){
    let out = [...list];
    if (Filters.review) out = out.filter(h => needsReview(h));
    if (Filters.queen) out = out.filter(h => needsQueenReplace(h.id));
    return out;
  }

  /* ===== Render: Hives ===== */
  function renderHives(){
    renderFilterButtons();
    const grid = $("hivesGrid");
    grid.innerHTML = "";

    const sorted = [...State.hives].sort((a,b) =>
      String(a.label).localeCompare(String(b.label), undefined, {numeric:true})
    );
    const filtered = filterHives(sorted);

    filtered.forEach(h => {
      const due = needsReview(h);
      const lastRev = lastReviewDateForHive(h.id);
      const qReplace = needsQueenReplace(h.id);

      const cq = getCurrentQueen(h.id);
      const qAge = queenAgeMonths(cq);

      const el = document.createElement("div");
      el.className = "card hive-card";
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div style="font-size:22px;font-weight:1000">${esc(h.label)}</div>
            <div class="small" style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
              <span class="pill">${h.kind==="odklad"?"Odk≈Çad":"Rodzina"} ${esc(h.year)}</span>
              ${h.place ? `<span class="pill">üìç ${esc(h.place)}</span>` : ``}
              ${
                h.nextVisitDate
                  ? `<span class="pill" style="border-color:${due?'#fecaca':'var(--border)'}">‚è≠ ${esc(isoToPL(h.nextVisitDate))}</span>`
                  : (due ? `<span class="pill" style="border-color:#fecaca">‚è≠ BRAK (DO PRZEGLƒÑDU)</span>` : ``)
              }
              ${
                cq ? `<span class="pill">üëë ${esc(cq.name || "matka")} ${cq.year&&cq.month?`(${esc(String(cq.month).padStart(2,"0"))}.${esc(cq.year)})`:""}${qAge!=null?` ‚Ä¢ ${qAge} mies.`:""}</span>` : `<span class="pill">üëë brak danych</span>`
              }
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">Ostatni przeglƒÖd</div>
            <div style="font-weight:1000">${lastRev ? isoToPL(lastRev) : "‚Äî"}</div>
          </div>
        </div>

        <div style="margin-top:10px;font-size:12px">
          <div class="${due?'text-alert':''}" style="margin-top:6px;font-weight:1000">
            ${due ? "üîé DO PRZEGLƒÑDU" : "‚úÖ OK"}
          </div>
          ${
            qReplace ? `<div class="text-alert" style="margin-top:6px;font-weight:1000">üëë MATKA DO WYMIANY</div>` : ``
          }
        </div>
      `;
      el.addEventListener("click", () => renderView("details", h.id, true));
      grid.appendChild(el);
    });

    if (!filtered.length){
      const empty = document.createElement("div");
      empty.className = "card text-center";
      empty.innerHTML = `
        <div style="font-weight:1000">Brak uli w tym filtrze.</div>
        <div class="small mt-2">Kliknij ‚ÄûWyczy≈õƒá‚Äù, ≈ºeby zobaczyƒá wszystkie.</div>
      `;
      grid.appendChild(empty);
    }
  }

  /* ===== Details ===== */
  function renderDetails(){
    const hiveId = State.currentHive;
    const hive = State.hives.find(h => h.id === hiveId);
    if (!hive){
      renderView("hives", null, true);
      return;
    }

    $("detailsTitle").textContent = `${hive.label} ‚Ä¢ ${hive.kind==="odklad"?"Odk≈Çad":"Rodzina"} ‚Ä¢ ${hive.year}`;

    $("hLabel").value = hive.label || hive.id || "";
    $("hPlace").value = hive.place || "";
    $("hType").value  = hive.kind || "rodzina";
    $("hYear").value  = hive.year || thisYear;
    $("hNextVisit").value = hive.nextVisitDate || "";

    $("revDate").value = $("revDate").value || todayISO();
    if (!$("revEditId").value) $("revNextDate").value = hive.nextVisitDate || "";

    $("feedDate").value = $("feedDate").value || todayISO();

    renderQueens();
    renderFeedings();
    renderReviews();
  }

  async function saveHiveMeta(){
    const oldId = State.currentHive;
    const hive = State.hives.find(h => h.id === oldId);
    if (!hive) return;

    const newLabel = ($("hLabel").value || "").trim();
    const newPlace = ($("hPlace").value || "").trim();
    const newNext  = ($("hNextVisit").value || "").trim();

    if (!newLabel) return alert("Numer / nazwa ula nie mo≈ºe byƒá pusta.");

    const newId = newLabel;
    if (newId !== oldId && State.hives.some(h => h.id === newId)){
      return alert("Taki numer/nazwa ula ju≈º istnieje. Wpisz inny.");
    }

    hive.kind  = $("hType").value;
    hive.year  = Number($("hYear").value) || thisYear;
    hive.place = newPlace;
    hive.nextVisitDate = newNext;

    if (newId !== oldId){
      hive.id = newId;
      hive.label = newLabel;

      State.reviews.forEach(r => { if (r.hiveId === oldId) r.hiveId = newId; });
      State.queens.forEach(q => { if (q.hiveId === oldId) q.hiveId = newId; });
      State.feedings.forEach(f => { if (f.hiveId === oldId) f.hiveId = newId; });

      await save("reviews");
      await save("queens");
      await save("feedings");

      State.currentHive = newId;
      const p = new URLSearchParams(location.search);
      p.set("v","details"); p.set("id", newId);
      history.replaceState({view:"details", hiveId:newId}, "", "?" + p.toString());
    } else {
      hive.label = newLabel;
    }

    await save("hives");
    renderDetails();
    renderHives();
  }

  /* ===== Queens ===== */
  function getQueensForCurrentHive(){
    const hiveId = State.currentHive;
    return State.queens
      .filter(q => q.hiveId === hiveId)
      .sort((a,b) => (b.isCurrent?1:0)-(a.isCurrent?1:0) || (b.ts||0)-(a.ts||0));
  }

  function clearQueenForm(){
    $("qEditId").value = "";
    $("qYear").value = "";
    $("qMonth").value = "";
    $("qName").value = "";
    $("qInsem").value = "";
    $("qLine").value = "";
    $("qOpalit").value = "";
    $("qGentle").value = "";
    $("qNote").value = "";
    $("qSetCurrent").checked = true;
    $("qSaveBtn").textContent = "ZAPISZ MATKƒò";
  }

  function renderQueens(){
    const items = getQueensForCurrentHive();
    $("qCountPill").textContent = String(items.length);

    const hiveId = State.currentHive;
    const cur = getCurrentQueen(hiveId);
    const age = queenAgeMonths(cur);
    const replace = needsQueenReplace(hiveId);

    const box = $("qCurrentBox");
    if (!cur){
      box.innerHTML = `
        <div class="muted">AKTUALNA MATKA</div>
        <div style="font-weight:1000;margin-top:6px">Brak wpisu.</div>
        <div class="small mt-2">Dodaj pierwszƒÖ matkƒô i zaznacz ‚ÄûUstaw jako aktualnƒÖ‚Äù.</div>
      `;
    } else {
      box.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div>
            <div class="muted">AKTUALNA MATKA</div>
            <div style="font-weight:1000;font-size:18px;margin-top:6px">${esc(cur.name || "matka")}</div>
            <div class="small mt-2">
              ${cur.year && cur.month ? `<b>${esc(String(cur.month).padStart(2,"0"))}.${esc(cur.year)}</b>` : `<b>‚Äî</b>`}
              ${age!=null ? ` ‚Ä¢ ${age} mies.` : ``}
            </div>
          </div>
          <div>
            ${replace ? `<span class="tag-danger">üëë MATKA DO WYMIANY</span>` : `<span class="pill">‚úÖ OK</span>`}
          </div>
        </div>
        <div class="hr"></div>
        <div class="small" style="display:grid;gap:4px">
          <div><b>Typ unasienniania:</b> ${esc(cur.insem||"‚Äî")}</div>
          <div><b>Linia / hodowca:</b> ${esc(cur.line||"‚Äî")}</div>
          <div><b>Opalitka:</b> ${esc(cur.opalit||"‚Äî")}</div>
          <div><b>≈Åagodno≈õƒá:</b> ${esc(cur.gentle||"‚Äî")}</div>
        </div>
        ${cur.note ? `<div class="hr"></div><div style="white-space:pre-wrap">${esc(cur.note)}</div>` : ``}
      `;
    }

    const list = $("qList");
    list.innerHTML = "";

    if (!items.length){
      list.innerHTML = `
        <div class="card text-center">
          <div style="font-weight:1000">Brak historii matek.</div>
          <div class="small mt-2">Dodaj wpis powy≈ºej.</div>
        </div>
      `;
      return;
    }

    items.forEach(q => {
      const qAge = queenAgeMonths(q);
      const isOld = q.isCurrent && qAge!=null && qAge>=24;

      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid " + (q.isCurrent ? "var(--purple)" : "var(--border)");
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:1000">
              ${q.isCurrent ? "‚≠ê " : ""}${esc(q.name || "(bez nazwy)")}
            </div>
            <div class="small">
              ${q.year && q.month ? `${esc(String(q.month).padStart(2,"0"))}.${esc(q.year)}` : "‚Äî"}
              ${qAge!=null ? ` ‚Ä¢ ${qAge} mies.` : ``}
              ${isOld ? ` ‚Ä¢ <span style="color:var(--danger);font-weight:1000">MATKA DO WYMIANY</span>` : ``}
            </div>
            <div class="small mt-2">
              Typ: <b>${esc(q.insem||"‚Äî")}</b> ‚Ä¢ Linia/Hod.: <b>${esc(q.line||"‚Äî")}</b> ‚Ä¢ Opalitka: <b>${esc(q.opalit||"‚Äî")}</b> ‚Ä¢ ≈Åagodno≈õƒá: <b>${esc(q.gentle||"‚Äî")}</b>
            </div>
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-q="current" data-id="${esc(q.id)}">USTAW AKT.</button>
            <button class="btn btn-slate" style="padding:6px 10px" data-q="edit" data-id="${esc(q.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-q="del" data-id="${esc(q.id)}">USU≈É</button>
          </div>
        </div>
        ${q.note ? `<div class="hr"></div><div style="white-space:pre-wrap">${esc(q.note)}</div>` : ``}
      `;
      list.appendChild(el);
    });

    if (!$("qEditId").value) $("qSetCurrent").checked = true;
  }

  async function setQueenCurrent(id){
    const hiveId = State.currentHive;
    const q = State.queens.find(x => x.id === id);
    if (!q) return;

    State.queens.forEach(x => { if (x.hiveId === hiveId) x.isCurrent = false; });
    q.isCurrent = true;
    q.ts = Date.now();

    await save("queens");
    renderQueens();
    renderHives();
  }

  function editQueen(id){
    const q = State.queens.find(x => x.id === id);
    if (!q) return;

    $("qEditId").value = q.id;
    $("qYear").value = q.year || "";
    $("qMonth").value = q.month || "";
    $("qName").value = q.name || "";
    $("qInsem").value = q.insem || "";
    $("qLine").value = q.line || "";
    $("qOpalit").value = q.opalit || "";
    $("qGentle").value = q.gentle || "";
    $("qNote").value = q.note || "";
    $("qSetCurrent").checked = !!q.isCurrent;
    $("qSaveBtn").textContent = "ZAPISZ ZMIANY";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function deleteQueen(id){
    if (!confirm("UsunƒÖƒá ten wpis matki?")) return;
    const q = State.queens.find(x => x.id === id);
    State.queens = State.queens.filter(x => x.id !== id);
    await save("queens");

    if (q?.isCurrent){
      const hiveId = State.currentHive;
      const left = State.queens.filter(x => x.hiveId === hiveId).sort((a,b) => (b.ts||0)-(a.ts||0));
      if (left[0]){
        State.queens.forEach(x => { if (x.hiveId === hiveId) x.isCurrent = false; });
        left[0].isCurrent = true;
        await save("queens");
      }
    }

    if ($("qEditId").value === id) clearQueenForm();
    renderQueens();
    renderHives();
  }

  async function saveQueen(){
    const hiveId = State.currentHive;

    const editId = ($("qEditId").value || "").trim();
    const year = ($("qYear").value || "").trim();
    const month = ($("qMonth").value || "").trim();
    const name = ($("qName").value || "").trim();
    const insem = ($("qInsem").value || "").trim();
    const line = ($("qLine").value || "").trim();
    const opalit = ($("qOpalit").value || "").trim();
    const gentle = ($("qGentle").value || "").trim();
    const note = ($("qNote").value || "").trim();
    const setCurrent = !!$("qSetCurrent").checked;

    if (!year || !month) return alert("Podaj rocznik (rok) i miesiƒÖc matki.");

    if (editId){
      const q = State.queens.find(x => x.id === editId);
      if (!q) return alert("Nie znaleziono wpisu do edycji.");
      q.year = year; q.month = month; q.name = name;
      q.insem = insem; q.line = line; q.opalit = opalit; q.gentle = gentle;
      q.note = note;
      q.ts = Date.now();

      if (setCurrent){
        State.queens.forEach(x => { if (x.hiveId === hiveId) x.isCurrent = false; });
        q.isCurrent = true;
      }
    } else {
      const q = {
        id: uid(),
        hiveId,
        year,
        month,
        name,
        insem,
        line,
        opalit,
        gentle,
        note,
        isCurrent: false,
        ts: Date.now()
      };

      if (setCurrent){
        State.queens.forEach(x => { if (x.hiveId === hiveId) x.isCurrent = false; });
        q.isCurrent = true;
      } else {
        const any = State.queens.some(x => x.hiveId === hiveId);
        q.isCurrent = !any;
      }

      State.queens.push(q);
    }

    await save("queens");
    clearQueenForm();
    renderQueens();
    renderHives();
  }

  /* ===== Feedings ===== */
  function getFeedingsForCurrentHive(){
    const hiveId = State.currentHive;
    return State.feedings
      .filter(f => f.hiveId === hiveId)
      .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0));
  }

  function clearFeedingForm(){
    $("feedEditId").value = "";
    $("feedDate").value = todayISO();
    $("feedType").value = "";
    $("feedAmount").value = "";
    $("feedUnit").value = "kg";
    $("feedSaveBtn").textContent = "ZAPISZ KARMIENIE";
  }

  function renderFeedings(){
    const items = getFeedingsForCurrentHive();
    $("feedCountPill").textContent = String(items.length);

    const list = $("feedList");
    list.innerHTML = "";

    if (!items.length){
      list.innerHTML = `
        <div class="card text-center">
          <div style="font-weight:1000">Brak wpis√≥w karmienia.</div>
          <div class="small mt-2">Dodaj pierwszy wpis powy≈ºej.</div>
        </div>
      `;
      return;
    }

    items.forEach(f => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--orange)";
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:1000">üçØ ${esc(isoToPL(f.date))} ‚Ä¢ ${esc(f.type||"‚Äî")}</div>
            <div class="small">Ilo≈õƒá: <b>${Number(f.amount||0).toFixed(2)}</b> ${esc(f.unit||"kg")}</div>
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-feed="edit" data-id="${esc(f.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-feed="del" data-id="${esc(f.id)}">USU≈É</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  function editFeeding(id){
    const f = State.feedings.find(x => x.id === id);
    if (!f) return;

    $("feedEditId").value = f.id;
    $("feedDate").value = f.date || todayISO();
    $("feedType").value = f.type || "";
    $("feedAmount").value = f.amount ?? "";
    $("feedUnit").value = f.unit || "kg";
    $("feedSaveBtn").textContent = "ZAPISZ ZMIANY";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function deleteFeeding(id){
    if (!confirm("UsunƒÖƒá ten wpis karmienia?")) return;
    State.feedings = State.feedings.filter(x => x.id !== id);
    await save("feedings");
    if ($("feedEditId").value === id) clearFeedingForm();
    renderFeedings();
  }

  async function saveFeeding(){
    const hiveId = State.currentHive;
    const editId = ($("feedEditId").value || "").trim();
    const date = ($("feedDate").value || "").trim();
    const type = ($("feedType").value || "").trim();
    const amount = Number($("feedAmount").value);
    const unit = $("feedUnit").value;

    if (!date) return alert("Podaj datƒô karmienia.");
    if (!type) return alert("Podaj rodzaj pokarmu.");
    if (!Number.isFinite(amount) || amount <= 0) return alert("Podaj ilo≈õƒá > 0.");

    if (editId){
      const f = State.feedings.find(x => x.id === editId);
      if (!f) return alert("Nie znaleziono wpisu do edycji.");
      f.date = date;
      f.type = type;
      f.amount = amount;
      f.unit = unit;
      f.ts = Date.now();
    } else {
      State.feedings.push({ id: uid(), hiveId, date, type, amount, unit, ts: Date.now() });
    }

    await save("feedings");
    clearFeedingForm();
    renderFeedings();
  }

  /* ===== Reviews ===== */
  function getReviewsForCurrentHive(){
    const hiveId = State.currentHive;
    return State.reviews
      .filter(r => r.hiveId === hiveId)
      .sort((a,b) => (b.visitDate||"").localeCompare(a.visitDate||"") || (b.ts||0)-(a.ts||0));
  }

  function clearReviewForm(){
    $("revEditId").value = "";
    $("revDate").value = todayISO();
    $("revNote").value = "";
    const hive = State.hives.find(h => h.id === State.currentHive);
    $("revNextDate").value = hive?.nextVisitDate || "";
    $("revSaveBtn").textContent = "ZAPISZ PRZEGLƒÑD";
  }

  function renderReviews(){
    const list = $("revList");
    list.innerHTML = "";

    const items = getReviewsForCurrentHive();
    $("revCountPill").textContent = String(items.length);

    if (!items.length){
      list.innerHTML = `
        <div class="card text-center">
          <div style="font-weight:1000">Brak przeglƒÖd√≥w.</div>
          <div class="small mt-2">Dodaj pierwszy przeglƒÖd powy≈ºej.</div>
        </div>
      `;
      return;
    }

    items.forEach(r => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--blue)";
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:1000">üìí ${esc(isoToPL(r.visitDate))}</div>
            <div class="small">Nastƒôpny: <b>${r.nextVisitDate ? esc(isoToPL(r.nextVisitDate)) : "‚Äî"}</b></div>
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-rev="edit" data-id="${esc(r.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-rev="del" data-id="${esc(r.id)}">USU≈É</button>
          </div>
        </div>
        <div class="hr"></div>
        <div style="white-space:pre-wrap">${esc(r.note || "")}</div>
      `;
      list.appendChild(el);
    });
  }

  async function saveReview(){
    const hiveId = State.currentHive;
    const hive = State.hives.find(h => h.id === hiveId);
    if (!hive) return;

    const editId = ($("revEditId").value || "").trim();
    const visitDate = ($("revDate").value || "").trim();
    const nextVisitDate = ($("revNextDate").value || "").trim();
    const note = ($("revNote").value || "").trim();

    if (!visitDate) return alert("Podaj datƒô przeglƒÖdu.");

    if (editId){
      const r = State.reviews.find(x => x.id === editId);
      if (!r) return alert("Nie znaleziono przeglƒÖdu do edycji.");
      r.visitDate = visitDate;
      r.nextVisitDate = nextVisitDate;
      r.note = note;
      r.ts = Date.now();
    } else {
      State.reviews.push({ id: uid(), hiveId, visitDate, nextVisitDate, note, ts: Date.now() });
    }

    if (nextVisitDate){
      hive.nextVisitDate = nextVisitDate;
      $("hNextVisit").value = nextVisitDate;
      await save("hives");
    }

    await save("reviews");
    clearReviewForm();
    renderReviews();
    renderHives();
  }

  function editReview(id){
    const r = State.reviews.find(x => x.id === id);
    if (!r) return;

    $("revEditId").value = r.id;
    $("revDate").value = r.visitDate || todayISO();
    $("revNextDate").value = r.nextVisitDate || "";
    $("revNote").value = r.note || "";
    $("revSaveBtn").textContent = "ZAPISZ ZMIANY";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function deleteReview(id){
    if (!confirm("UsunƒÖƒá ten przeglƒÖd?")) return;
    State.reviews = State.reviews.filter(x => x.id !== id);
    await save("reviews");
    if ($("revEditId").value === id) clearReviewForm();
    renderReviews();
    renderHives();
  }

  /* ===== Calendar / Finance / Inventory / Knowledge (bez zmian logicznych) ===== */
  function ensureCalendarYear(y){ if (!State.calendar[y]) State.calendar[y] = {}; }

  function renderCalendar(){
    const months = ["Stycze≈Ñ","Luty","Marzec","Kwiecie≈Ñ","Maj","Czerwiec","Lipiec","Sierpie≈Ñ","Wrzesie≈Ñ","Pa≈∫dziernik","Listopad","Grudzie≈Ñ"];
    const yearSel = $("calYear");

    if (!yearSel.options.length){
      for (let y=2022;y<=2027;y++){
        const o=document.createElement("option");
        o.value=String(y); o.textContent=String(y);
        yearSel.appendChild(o);
      }
    }

    const current = yearSel.value || String(thisYear);
    yearSel.value = (Number(current)>=2022 && Number(current)<=2027) ? current : String(thisYear);

    ensureCalendarYear(yearSel.value);

    const grid = $("calendarGrid");
    grid.innerHTML = "";

    months.forEach((m,idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div style="font-weight:1000;color:#4f46e5;margin-bottom:6px">${m} ${yearSel.value}</div>`;
      const area = document.createElement("textarea");
      area.className="input";
      area.style.height="75px";
      area.value = State.calendar[yearSel.value][idx] || "";
      area.addEventListener("change", async (e) => {
        ensureCalendarYear(yearSel.value);
        State.calendar[yearSel.value][idx] = e.target.value;
        await save("calendar");
      });
      card.appendChild(area);
      grid.appendChild(card);
    });

    yearSel.onchange = () => renderCalendar();
  }

  function renderFinance(){
    const list = $("finList");
    list.innerHTML = "";

    let inc=0, exp=0;
    const items = [...State.finance].sort((a,b) => (b.date||"").localeCompare(a.date||""));

    items.forEach(f => {
      if (f.type === "income") inc += Number(f.amount||0);
      else exp += Number(f.amount||0);

      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid " + (f.type==="income" ? "var(--success)" : "var(--danger)");
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div style="font-weight:1000">${esc(f.desc)}</div>
            <div class="small">${isoToPL(f.date)} ‚Ä¢ ${f.type==="income"?"Przych√≥d":"Wydatek"}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:1000;color:${f.type==="income"?"var(--success)":"var(--danger)"}">
              ${f.type==="income"?"+":"-"}${Number(f.amount||0).toFixed(2)} z≈Ç
            </div>
            <div class="flex gap-2" style="justify-content:flex-end;margin-top:8px">
              <button class="btn btn-slate" style="padding:6px 10px" data-del="fin" data-id="${esc(f.id)}">USU≈É</button>
            </div>
          </div>
        </div>
      `;
      list.appendChild(el);
    });

    $("finInc").textContent = inc.toFixed(2);
    $("finExp").textContent = exp.toFixed(2);
    const bal = inc-exp;
    $("finBalance").textContent = bal.toFixed(2) + " PLN";
    $("finBalance").style.color = bal>=0 ? "var(--success)" : "var(--danger)";
  }

  async function addFinance(){
    const type = $("finType").value;
    const date = $("finDate").value || todayISO();
    const amount = Number($("finAmount").value);
    const desc = ($("finDesc").value || "").trim();

    if (!desc || !Number.isFinite(amount) || amount<=0){
      return alert("Podaj opis i kwotƒô > 0.");
    }

    State.finance.push({ id:uid(), type, date, amount, desc });
    await save("finance");

    $("finAmount").value = "";
    $("finDesc").value = "";
    renderFinance();
  }

  function invCalcQtyAtDate(itemId, isoDate){
    const d = isoDate || todayISO();
    return State.invMoves
      .filter(m => m.itemId === itemId && (m.date||"") <= d)
      .reduce((s,m) => s + (Number(m.delta)||0), 0);
  }

  function invCalcCurrentQty(itemId){
    return State.invMoves
      .filter(m => m.itemId === itemId)
      .reduce((s,m) => s + (Number(m.delta)||0), 0);
  }

  function refreshInvSelectors(){
    const items = [...State.invItems].sort((a,b) => String(a.name).localeCompare(String(b.name)));
    const sel  = $("invItemSel");
    const qsel = $("invQueryItem");

    sel.innerHTML  = `<option value="">Wybierz produkt‚Ä¶</option>`;
    qsel.innerHTML = `<option value="">Wybierz produkt‚Ä¶</option>`;

    items.forEach(it => {
      const o=document.createElement("option");
      o.value=it.id; o.textContent=it.name;
      sel.appendChild(o);

      const o2=document.createElement("option");
      o2.value=it.id; o2.textContent=it.name;
      qsel.appendChild(o2);
    });
  }

  function renderInventory(){
    refreshInvSelectors();
    $("invMoveDate").value  = $("invMoveDate").value  || todayISO();
    $("invQueryDate").value = $("invQueryDate").value || todayISO();

    const list = $("invList");
    list.innerHTML = "";

    const items = [...State.invItems].sort((a,b) => String(a.name).localeCompare(String(b.name)));
    if (!items.length){
      list.innerHTML = `
        <div class="card text-center">
          <div style="font-weight:1000">Brak produkt√≥w w magazynie.</div>
          <div class="small mt-2">Dodaj pierwszy ruch (np. zakup).</div>
        </div>
      `;
      return;
    }

    for (const it of items){
      const qty = invCalcCurrentQty(it.id);
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--slate)";

      const lastMoves = State.invMoves
        .filter(m => m.itemId === it.id)
        .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0))
        .slice(0,3);

      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:1000">${esc(it.name)}</div>
            <div class="small">Aktualnie: <b>${qty.toFixed(2)}</b></div>
          </div>
          <div class="flex gap-2 items-center" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-invquick="-1" data-id="${esc(it.id)}">‚àí1</button>
            <button class="btn btn-slate" style="padding:6px 10px" data-invquick="+1" data-id="${esc(it.id)}">+1</button>
            <button class="btn btn-slate" style="padding:6px 10px" data-del="invitem" data-id="${esc(it.id)}">USU≈É</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="small">Ostatnie ruchy:</div>
        <div style="display:grid;gap:6px;margin-top:8px">
          ${
            lastMoves.length ? lastMoves.map(m => `
              <div class="flex justify-between items-center" style="gap:10px">
                <div class="small" style="flex:1"><b>${isoToPL(m.date)}</b> ‚Ä¢ ${esc(m.note||"‚Äî")}</div>
                <div style="font-weight:1000;color:${Number(m.delta)>=0?'var(--success)':'var(--danger)'}">
                  ${Number(m.delta)>=0?'+':''}${Number(m.delta||0).toFixed(2)}
                </div>
                <button class="btn btn-slate" style="padding:6px 10px" data-del="invmove" data-id="${esc(m.id)}">‚úï</button>
              </div>
            `).join("") : `<div class="small">Brak ruch√≥w.</div>`
          }
        </div>
      `;
      list.appendChild(el);
    }
  }

  async function invAddMove(){
    const selId  = $("invItemSel").value;
    const newName = ($("invNewName").value || "").trim();
    const date   = $("invMoveDate").value || todayISO();
    const delta  = Number($("invMoveDelta").value);
    const note   = ($("invMoveNote").value || "").trim();

    if (!Number.isFinite(delta) || delta===0) return alert("Podaj ilo≈õƒá (r√≥≈ºnƒÖ od 0).");
    if (!date) return alert("Podaj datƒô.");

    let itemId = selId;

    if (!itemId){
      if (!newName) return alert("Wybierz produkt lub wpisz nowy.");
      const ex = State.invItems.find(x => String(x.name).toLowerCase() === newName.toLowerCase());
      if (ex) itemId = ex.id;
      else {
        itemId = uid();
        State.invItems.push({ id:itemId, name:newName });
        await save("invItems");
      }
    }

    State.invMoves.push({ id:uid(), itemId, date, delta, note, ts:Date.now() });
    await save("invMoves");

    $("invMoveDelta").value = "";
    $("invMoveNote").value = "";
    $("invNewName").value = "";
    $("invItemSel").value = "";

    renderInventory();
  }

  async function invQuickDelta(itemId, delta){
    State.invMoves.push({ id:uid(), itemId, date:todayISO(), delta, note:"Korekta szybka", ts:Date.now() });
    await save("invMoves");
    renderInventory();
  }

  function invQuery(){
    const itemId = $("invQueryItem").value;
    const date = $("invQueryDate").value || todayISO();
    const box = $("invQueryResult");
    box.innerHTML = "";

    if (!itemId) return alert("Wybierz produkt do sprawdzenia.");

    const item = State.invItems.find(x => x.id === itemId);
    const qty = invCalcQtyAtDate(itemId, date);

    box.innerHTML = `
      <div class="card" style="border-left:4px solid var(--blue);padding:12px">
        <div class="muted">WYNIK</div>
        <div style="font-weight:1000;font-size:20px;margin-top:6px">${esc(item?.name || "")}</div>
        <div class="small" style="margin-top:6px">Stan na dzie≈Ñ <b>${isoToPL(date)}</b>:</div>
        <div style="font-weight:1000;font-size:26px;margin-top:6px;color:var(--blue)">${qty.toFixed(2)}</div>
      </div>
    `;
  }

  function refreshTopicSelect(){
    const sel = $("knowTopic");
    sel.innerHTML = "";
    (State.topics.length ? State.topics : ["Og√≥lne"]).forEach(t => {
      const o=document.createElement("option");
      o.value=t; o.textContent=t;
      sel.appendChild(o);
    });
  }

  function renderKnowledge(){
    refreshTopicSelect();
    const wrap = $("knowList");
    wrap.innerHTML = "";
    const byTopic = {};
    for (const n of State.knowledge){
      const t = n.topic || "Og√≥lne";
      if (!byTopic[t]) byTopic[t]=[];
      byTopic[t].push(n);
    }
    const topics = [...new Set([...State.topics, ...Object.keys(byTopic)])].filter(Boolean);
    topics.forEach(t => {
      const items = (byTopic[t] || []).sort((a,b) => (b.dateTS||0)-(a.dateTS||0));
      const sec = document.createElement("div");
      sec.className = "card";
      sec.style.borderLeft = "4px solid var(--purple)";
      sec.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div style="font-weight:1000;color:var(--purple)">${esc(t)}</div>
          <div class="small">${items.length} not.</div>
        </div>
      `;
      wrap.appendChild(sec);
    });
  }

  async function addTopic(){
    const t = ($("knowNewTopic").value || "").trim();
    if (!t) return;
    if (!State.topics.includes(t)) State.topics.push(t);
    await save("topics");
    $("knowNewTopic").value = "";
    renderKnowledge();
  }

  async function addKnowledge(){
    const topic = $("knowTopic").value || "Og√≥lne";
    const title = ($("knowTitle").value || "").trim();
    const body  = ($("knowBody").value || "").trim();
    if (!title && !body) return alert("Wpisz tytu≈Ç lub tre≈õƒá.");
    State.knowledge.push({ id:uid(), topic, title:title||"(bez tytu≈Çu)", body, dateTS:Date.now() });
    await save("knowledge");
    $("knowTitle").value = "";
    $("knowBody").value = "";
    renderKnowledge();
  }

  /* ===== Export / Import ===== */
  async function exportBackup(){
    const out = {
      meta:{ app:"Pasiecznik ULTRA", exportedAt:new Date().toISOString() },
      data:{
        hives: State.hives,
        reviews: State.reviews,
        queens: State.queens,
        feedings: State.feedings,
        calendar: State.calendar,
        finance: State.finance,
        invItems: State.invItems,
        invMoves: State.invMoves,
        topics: State.topics,
        knowledge: State.knowledge
      }
    };
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "pasiecznik_backup_" + new Date().toLocaleDateString("pl-PL") + ".json";
    a.click();
  }

  async function importBackup(file){
    const txt = await file.text();
    let parsed;
    try { parsed = JSON.parse(txt); } catch { return alert("B≈Çƒôdny plik."); }
    if (!confirm("Nadpisaƒá wszystkie dane w aplikacji?")) return;

    const data = parsed.data || parsed;

    State.hives     = data.hives     || [];
    State.reviews   = data.reviews   || [];
    State.queens    = data.queens    || [];
    State.feedings  = data.feedings  || [];

    State.calendar  = data.calendar  || {};
    State.finance   = data.finance   || [];
    State.invItems  = data.invItems  || [];
    State.invMoves  = data.invMoves  || [];
    State.topics    = data.topics    || ["Og√≥lne"];
    State.knowledge = data.knowledge || [];

    await dbSet("hives", State.hives);
    await dbSet("reviews", State.reviews);
    await dbSet("queens", State.queens);
    await dbSet("feedings", State.feedings);

    await dbSet("calendar", State.calendar);
    await dbSet("finance", State.finance);
    await dbSet("invItems", State.invItems);
    await dbSet("invMoves", State.invMoves);
    await dbSet("topics", State.topics);
    await dbSet("knowledge", State.knowledge);

    alert("Przywr√≥cono dane.");
    renderView("hives", null, true);
  }

  /* ===== Add Hive ===== */
  async function addHive(){
    const label = prompt("Numer/Nazwa ula (np. 12, A1):");
    if (!label) return;

    const place = prompt("Po≈Ço≈ºenie ula (opcjonalnie, np. RzƒÖd 2 / 3 od lewej):", "") || "";
    const kindRaw = prompt("Typ ula: wpisz R (rodzina) lub O (odk≈Çad)", "R");
    const year = Number(prompt("Rok (np. 2025):", String(thisYear))) || thisYear;

    const id = label.trim();
    if (State.hives.some(h => h.id === id)){
      alert("Taki ul ju≈º istnieje.");
      return;
    }

    State.hives.push({
      id,
      label: id,
      place: place.trim(),
      kind: String(kindRaw||"R").toUpperCase().startsWith("O") ? "odklad" : "rodzina",
      year,
      nextVisitDate: ""
    });

    await save("hives");
    renderHives();
  }

  /* ===== Delete dispatcher (finance/inv/know) ===== */
  async function handleDelete(type, id){
    if (!confirm("UsunƒÖƒá?")) return;

    if (type === "fin"){
      State.finance = State.finance.filter(x => x.id !== id);
      await save("finance");
      renderFinance();
      return;
    }

    if (type === "invmove"){
      State.invMoves = State.invMoves.filter(x => x.id !== id);
      await save("invMoves");
      renderInventory();
      return;
    }

    if (type === "invitem"){
      const it = State.invItems.find(x => x.id === id);
      if (!it) return;
      if (!confirm(`UsunƒÖƒá produkt "${it.name}" oraz ca≈ÇƒÖ historiƒô ruch√≥w?`)) return;

      State.invItems = State.invItems.filter(x => x.id !== id);
      State.invMoves = State.invMoves.filter(x => x.itemId !== id);

      await save("invItems");
      await save("invMoves");
      renderInventory();
      return;
    }

    if (type === "know"){
      State.knowledge = State.knowledge.filter(x => x.id !== id);
      await save("knowledge");
      renderKnowledge();
      return;
    }
  }

  /* ===== START ===== */
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      await openDB();
      await loadAll();

      $("topNav").addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-view]");
        if (!btn) return;
        renderView(btn.dataset.view, null, true);
      });

      $("addHiveBtn").addEventListener("click", addHive);
      $("backBtn").addEventListener("click", ()=>renderView("hives", null, true));

      $("fltReviewBtn").addEventListener("click", ()=>{ Filters.review=!Filters.review; renderHives(); });
      $("fltQueenBtn").addEventListener("click", ()=>{ Filters.queen=!Filters.queen; renderHives(); });
      $("fltClearBtn").addEventListener("click", ()=>{ Filters.review=false; Filters.queen=false; renderHives(); });

      $("saveHiveMetaBtn").addEventListener("click", saveHiveMeta);

      $("qSaveBtn").addEventListener("click", saveQueen);
      $("qCancelBtn").addEventListener("click", (e)=>{ e.preventDefault(); clearQueenForm(); });

      $("feedSaveBtn").addEventListener("click", saveFeeding);
      $("feedCancelBtn").addEventListener("click", (e)=>{ e.preventDefault(); clearFeedingForm(); });

      $("revSaveBtn").addEventListener("click", saveReview);
      $("revCancelBtn").addEventListener("click", (e)=>{ e.preventDefault(); clearReviewForm(); });

      $("addFinBtn").addEventListener("click", addFinance);
      $("finDate").value = todayISO();

      $("invAddMoveBtn").addEventListener("click", invAddMove);
      $("invQueryBtn").addEventListener("click", invQuery);
      $("invMoveDate").value = todayISO();
      $("invQueryDate").value = todayISO();

      $("addTopicBtn").addEventListener("click", addTopic);
      $("addKnowBtn").addEventListener("click", addKnowledge);

      $("exportBtn").addEventListener("click", exportBackup);
      $("importFile").addEventListener("change", async (e)=>{
        const f = e.target.files?.[0];
        e.target.value="";
        if (!f) return;
        await importBackup(f);
      });

      document.body.addEventListener("click", async (e)=>{
        const d = e.target.closest("[data-del]");
        if (d) return handleDelete(d.getAttribute("data-del"), d.getAttribute("data-id"));

        const iq = e.target.closest("[data-invquick]");
        if (iq){
          const itemId = iq.getAttribute("data-id");
          const delta = iq.getAttribute("data-invquick") === "+1" ? 1 : -1;
          return invQuickDelta(itemId, delta);
        }

        const rv = e.target.closest("[data-rev]");
        if (rv){
          const id = rv.getAttribute("data-id");
          const act = rv.getAttribute("data-rev");
          if (act === "edit") return editReview(id);
          if (act === "del") return deleteReview(id);
        }

        const q = e.target.closest("[data-q]");
        if (q){
          const id = q.getAttribute("data-id");
          const act = q.getAttribute("data-q");
          if (act === "current") return setQueenCurrent(id);
          if (act === "edit") return editQueen(id);
          if (act === "del") return deleteQueen(id);
        }

        const fd = e.target.closest("[data-feed]");
        if (fd){
          const id = fd.getAttribute("data-id");
          const act = fd.getAttribute("data-feed");
          if (act === "edit") return editFeeding(id);
          if (act === "del") return deleteFeeding(id);
        }
      });

      const p = new URLSearchParams(location.search);
      const v = p.get("v") || "hives";
      const id = p.get("id");
      if (v === "details" && id) renderView("details", id, false);
      else renderView(v, null, false);

      clearQueenForm();
      clearFeedingForm();

    } catch (e) {
      console.error(e);
      document.body.innerHTML = `<h1 style="color:red;padding:16px">B≈ÇƒÖd aplikacji: ${esc(e?.message||String(e))}</h1>`;
    }
  });

})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(console.warn);
  }
</script>

</body>
</html>
