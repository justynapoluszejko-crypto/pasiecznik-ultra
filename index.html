<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Pasiecznik ULTRA PRO</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#A9711C">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Miodowo-leÅ›ny (B1) */
      --primary:#D9A441;          /* miÃ³d jasny */
      --primary-dark:#A9711C;     /* bursztyn */

      --bg:#F4F1EC;               /* ciepÅ‚y beÅ¼ tÅ‚a */
      --white:#FFFDF8;            /* ciepÅ‚a biel kart */
      --text:#1F2A24;             /* ciemna zieleÅ„-czerÅ„ */

      --danger:#9C3A2B;           /* naturalna czerwieÅ„ */
      --success:#2F5D50;          /* zieleÅ„ lasu */
      --blue:#6B7F3E;             /* oliwka (akcje pomocnicze) */

      --slate:#7A5C3E;            /* drewno */
      --purple:#2F5D50;           /* leÅ›ny akcent (zamiast fioletu) */
      --emerald:#2F5D50;          /* leÅ›ny */
      --orange:#E3B23C;           /* zgaszony Å¼Ã³Å‚ty */

      --border:#E6DCCF;           /* ciepÅ‚y obrys */
    }
    
    /* STYL CZCIONKI: Inter + System Native */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        background-color:var(--bg);
        /* Zmiana tÅ‚a na proste heksagony (plaster miodu) - rÃ³wne */
        background-image: url("data:image/svg+xml,%3Csvg width='56' height='100' viewBox='0 0 56 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M28 66L0 50L0 16L28 0L56 16L56 50L28 66L28 100' fill='none' stroke='%23D9A441' stroke-width='1' opacity='0.15'/%3E%3Cpath d='M28 0L28 34L0 50L0 84L28 100L56 84L56 50L28 34' fill='none' stroke='%23D9A441' stroke-width='1' opacity='0.15'/%3E%3C/svg%3E");
        background-size: 56px 100px; 
        background-attachment:fixed;
        color:var(--text);
        margin:0;
        padding-bottom:90px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .header{background:var(--primary);color:#fff;padding:12px;position:sticky;top:0;z-index:50;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .header-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .header-title{font-weight:700;text-transform:uppercase;letter-spacing:0.5px;font-size:1.05rem}
    .nav-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:5px;scrollbar-width:none}
    .nav-scroll::-webkit-scrollbar{display:none}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media (min-width:640px){.grid-hives{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:768px){.grid-hives{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:1024px){.grid-hives{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:639px){.grid-hives{grid-template-columns:repeat(2,1fr)}}
    
    .btn{border:none;padding:8px 16px;border-radius:10px;font-weight:600;cursor:pointer;text-transform:uppercase;font-size:.75rem;transition:.2s;color:#fff;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap; letter-spacing: 0.3px;}
    .btn:active{transform:scale(.96)}
    .btn-nav{background:var(--primary-dark);border:1px solid rgba(255,255,255,.18)}
    .btn-green{background:var(--success)}
    .btn-red{background:var(--danger)}
    .btn-blue{background:var(--blue)}
    .btn-slate{background:var(--slate)}
    .btn-orange{background:var(--orange)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn-ghost:active{transform:scale(.98)}
    .btn-chip{background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.12);padding:8px 10px}
    .btn-chip.active{background:var(--blue)}
    .btn-chip.active-red{background:var(--danger)}
    .btn-chip.active-slate{background:var(--slate); border-color:#fff;}
    .card{background:var(--white);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);border:1px solid var(--border)}
    .input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;box-sizing:border-box;background:#fff; font-family: inherit;}
    .input:focus{outline:2px solid var(--primary);border-color:transparent}
    .hidden{display:none!important}
    .flex{display:flex}
    .gap-2{gap:8px}
    .gap-3{gap:12px}
    .justify-between{justify-content:space-between}
    .items-center{align-items:center}
    .w-full{width:100%}
    .text-center{text-align:center}
    .mb-2{margin-bottom:8px}
    .mt-2{margin-top:8px}
    .mt-3{margin-top:12px}
    .hive-card{border-bottom:6px solid var(--primary);cursor:pointer;transition:transform .2s}
    .hive-card:hover{transform:translateY(-2px)}
    .hive-card.archived{opacity:0.7; filter:grayscale(0.8); border-bottom-color:#94a3b8;}
    
    .text-alert{color:var(--danger);font-weight:700;animation:blink 2s infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:.55}100%{opacity:1}}
    details{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff}
    details>summary{background:#f8fafc;padding:12px;font-weight:700;cursor:pointer;list-style:none;font-size:.8rem;text-transform:uppercase;color:#475569;display:flex;justify-content:space-between;align-items:center; letter-spacing: 0.5px;}
    details[open]>summary{background:#e2e8f0}
    .details-content{padding:12px;border-top:1px solid var(--border);display:grid;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:600;font-size:11px;border:1px solid var(--border);background:#fff}
    .muted{color:#64748b;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:1px}
    .small{font-size:12px;color:#64748b;font-weight:500}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:700px){.row.cols2{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.row.cols3{grid-template-columns:1fr 1fr 1fr}}
    
    /* Input Label helper */
    .lbl { display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase;}

    /* Confirm dialog */
    .confirm-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .confirm-overlay.show{display:flex}
    .confirm-box{width:min(520px,100%);background:#fff;border-radius:18px;border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    .confirm-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .confirm-title{font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:14px}
    .confirm-body{padding:16px}
    .confirm-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:110px;transform:translateX(-50%);background:#0f172a;color:#fff;
      padding:10px 14px;border-radius:14px;font-weight:600;box-shadow:0 10px 30px rgba(0,0,0,.25);
      z-index:10001;max-width:min(560px,92%);text-align:center;display:none}
    .toast.show{display:block}

    /* Voice recording animation */
    .btn-mic-active {
        background-color: var(--danger) !important;
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="flex items-center gap-2">
      <button id="backBtn" class="btn btn-nav hidden" aria-label="Wstecz">â¬…</button>
      <div id="appTitle" class="header-title">PASIECZNIK ULTRA</div>
    </div>
    <div class="flex gap-2">
      <button id="exportBtn" class="btn btn-green">â¬‡ KOPIA</button>
      <label class="btn btn-slate" style="cursor:pointer">
        â¬† IMPORT
        <input id="importFile" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>

  <div class="nav-scroll" id="topNav">
    <button data-view="hives" class="btn btn-nav">ğŸ Pasieka</button>
    <button data-view="calendar" class="btn btn-nav" style="background:var(--success)">ğŸ“… Kalendarz</button>
    <button data-view="finance" class="btn btn-nav" style="background:var(--emerald)">ğŸ’° Finanse</button>
    <button data-view="inventory" class="btn btn-nav" style="background:var(--slate)">ğŸ“¦ Magazyn</button>
    <button data-view="knowledge" class="btn btn-nav" style="background:var(--purple)">ğŸ§  Wiedza</button>
    <button id="addHiveBtn" class="btn btn-green">+ UL</button>
  </div>
</header>

<main class="container">
  <section id="viewHives" class="grid">
    <div class="card" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">FILTRY EKRANU GÅÃ“WNEGO</div>
      <div class="flex gap-2" style="flex-wrap:wrap">
        <button id="fltReviewBtn" class="btn btn-chip">ğŸ” DO PRZEGLÄ„DU</button>
        <button id="fltQueenBtn" class="btn btn-chip">ğŸ‘‘ MATKA DO WYMIANY</button>
        |
        <button id="fltArchivedBtn" class="btn btn-chip">ğŸ—„ï¸ ARCHIWUM</button>
        <button id="fltClearBtn" class="btn btn-ghost" style="padding:8px 10px">WYCZYÅšÄ†</button>
      </div>
      <div class="small mt-2">
        â€Do przeglÄ…duâ€ = ul z terminem nastÄ™pnego przeglÄ…du na dziÅ› / wstecz, albo (jeÅ›li brak terminu) ostatni przeglÄ…d starszy niÅ¼ 6 dni.<br/>
        â€Matka do wymianyâ€ = aktualna matka ma wiek &gt;= 24 miesiÄ…ce.<br/>
        â€Archiwumâ€ = ule nieaktywne (np. poÅ‚Ä…czone).
      </div>
    </div>
    <div id="hivesGrid" class="grid grid-hives"></div>
  </section>

  <section id="viewDetails" class="hidden grid">
    <div class="card" style="border-left:6px solid var(--primary)">
      <div class="muted">UL</div>
      <div id="detailsTitle" style="font-weight:700;font-size:18px;margin-top:6px"></div>
      <div class="hr"></div>

      <div class="row cols2">
        <input id="hLabel" class="input" type="text" placeholder="Numer / nazwa ula (np. 12, A1)">
        <input id="hPlace" class="input" type="text" placeholder="PoÅ‚oÅ¼enie (np. RzÄ…d 2 / 3 od lewej)">
      </div>
      <div class="row cols3">
        <select id="hType" class="input">
          <option value="rodzina">Rodzina</option>
          <option value="odklad">OdkÅ‚ad</option>
        </select>
        <input id="hYear" class="input" type="number" placeholder="Rok (np. 2025)">
        <input id="hNextVisit" class="input" type="date" title="Termin nastÄ™pnego przeglÄ…du">
      </div>
      <div class="row">
        <button id="saveHiveMetaBtn" class="btn btn-blue w-full">ZAPISZ METADANE ULA</button>
      </div>
    </div>

    <details open>
      <summary>ğŸ” PrzeglÄ…dy <span class="small" id="reviewsCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <label>
             <span class="lbl">Data przeglÄ…du</span>
             <input id="revDate" type="date" class="input">
          </label>
          <label>
             <span class="lbl">NastÄ™pny przeglÄ…d (Plan)</span>
             <input id="revNext" type="date" class="input">
          </label>
          <div style="display:flex; align-items:flex-end">
             <button id="revSaveBtn" class="btn btn-blue w-full" style="height:42px">ZAPISZ</button>
          </div>
        </div>
        
        <div class="flex items-center gap-2 mt-2">
            <button id="voiceNoteBtn" class="btn btn-slate w-full">ğŸ¤ NAGRAJ NOTATKÄ˜ (Start/Stop)</button>
        </div>
        <div class="small text-center mt-2" style="font-size:10px; color:#64748b;">Powiedz "KONIEC NAGRYWANIA" aby zapisaÄ‡ automatycznie.</div>
        
        <textarea id="revNote" class="input mt-2" style="height:90px" placeholder="Notatka z przeglÄ…du (pisz lub dyktuj)..."></textarea>
        <div class="small">MoÅ¼esz edytowaÄ‡ wpis: kliknij â€Edytujâ€ przy przeglÄ…dzie.</div>
        <div id="revList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <details>
      <summary>ğŸ¯ Karmienie <span class="small" id="feedCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="feedDate" type="date" class="input">
          <select id="feedType" class="input">
            <option value="syrop">Syrop</option>
            <option value="ciasto">Ciasto</option>
            <option value="inny">Inny</option>
          </select>
          <input id="feedQty" type="number" step="0.01" class="input" placeholder="IloÅ›Ä‡ (kg lub l)">
        </div>
        <input id="feedNote" type="text" class="input" placeholder="Notatka (opcjonalnie)">
        <div class="row cols2">
          <button id="feedSaveBtn" class="btn btn-slate">ZAPISZ KARMIENIE</button>
          <button id="feedClearBtn" class="btn btn-ghost">WYCZYÅšÄ† EDYCJÄ˜</button>
        </div>
        <div id="feedList" class="grid" style="gap:10px"></div>
      </div>
    </details>


    <details>
      <summary>ğŸ’Š Leczenie <span class="small" id="treatCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="treatDate" type="date" class="input">
          <input id="treatType" type="text" class="input" placeholder="Lek / Å›rodek">
          <input id="treatQty" type="text" class="input" placeholder="IloÅ›Ä‡ (np. ml, g, paski)">
        </div>
        <div class="row cols2">
          <button id="treatSaveBtn" class="btn btn-red">ZAPISZ LECZENIE</button>
          <button id="treatClearBtn" class="btn btn-ghost">WYCZYÅšÄ†</button>
        </div>
        <div id="treatList" class="grid" style="gap:10px"></div>
      </div>
    </details>


    <details>
      <summary>ğŸ‘‘ Matki (historia) <span class="small" id="queenCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="qName" type="text" class="input" placeholder="Nazwa matki (np. Mira)">
          <input id="qYear" type="number" class="input" placeholder="Rocznik (np. 2024)">
          <input id="qMonth" type="number" min="1" max="12" class="input" placeholder="MiesiÄ…c (1-12)">
        </div>
        <div class="row cols3">
          <input id="qMating" type="text" class="input" placeholder="Typ unasienniania (opcjonalnie)">
          <input id="qLine" type="text" class="input" placeholder="Linia / hodowca (opcjonalnie)">
          <input id="qOpalit" type="text" class="input" placeholder="Kolor opalitki / brak (opcjonalnie)">
        </div>
        <div class="row cols2">
          <select id="qGentle" class="input">
            <option value="">ÅagodnoÅ›Ä‡ (opcjonalnie)</option>
            <option value="1">1 â€“ trudna</option>
            <option value="2">2</option>
            <option value="3">3 â€“ OK</option>
            <option value="4">4</option>
            <option value="5">5 â€“ super</option>
          </select>
          <button id="queenSaveBtn" class="btn" style="background:var(--purple)">ZAPISZ MATKÄ˜</button>
        </div>
        <textarea id="qNote" class="input" style="height:80px" placeholder="Wolna notatka (opcjonalnie)"></textarea>
        <div class="row cols2">
          <button id="queenClearBtn" class="btn btn-ghost">WYCZYÅšÄ† EDYCJÄ˜</button>
          <div class="small">Kliknij â€Ustaw aktualnÄ…â€ na wpisie, Å¼eby oznaczyÄ‡ aktualnÄ… matkÄ™ w ulu.</div>
        </div>
        <div id="queenList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <details>
      <summary>ğŸ¯ Miodobranie <span class="small" id="harvCount">0</span></summary>
      <div class="details-content">
        <div class="row cols3">
          <input id="harvDate" type="date" class="input">
          <input id="harvType" type="text" class="input" placeholder="Rodzaj miodu (np. lipowy)">
          <input id="harvKg" type="number" step="0.01" class="input" placeholder="IloÅ›Ä‡ (kg)">
        </div>
        <div class="row cols2">
          <button id="harvSaveBtn" class="btn btn-orange">ZAPISZ MIODOBRANIE</button>
          <button id="harvClearBtn" class="btn btn-ghost">WYCZYÅšÄ† EDYCJÄ˜</button>
        </div>
        <div id="harvList" class="grid" style="gap:10px"></div>
      </div>
    </details>

    <div class="card" style="border-left:6px solid var(--slate); margin-top:20px;">
        <div class="muted">ZARZÄ„DZANIE ULEM</div>
        <div class="row mt-2">
           <button id="archiveHiveBtn" class="btn btn-slate w-full">ğŸ“¦ ARCHIWIZUJ / POÅÄ„CZ</button>
        </div>
        <div class="small mt-2">UÅ¼yj tej opcji, gdy Å‚Ä…czysz rodziny lub likwidujesz ul. Ul zostanie oznaczony jako nieaktywny, ale zachowasz jego historiÄ™.</div>
    </div>

  </section>

  <section id="viewCalendar" class="hidden">
    <div class="flex gap-2 items-center mb-2">
      <div class="pill">ğŸ“… KALENDARZ</div>
      <select id="calYear" class="input" style="max-width:200px"></select>
    </div>
    <div id="calendarGrid" class="grid cols-2" style="gap:10px"></div>
  </section>

  <section id="viewFinance" class="hidden">
    <div class="card text-center" style="border-top:5px solid var(--emerald);margin-bottom:16px">
      <div class="muted">BILANS</div>
      <div id="finBalance" style="font-weight:700;margin:6px 0;font-size:30px">0.00 PLN</div>
      <div class="flex justify-between" style="font-size:10px;font-weight:700">
        <span style="color:var(--success)">PRZYCHÃ“D: <span id="finInc">0</span></span>
        <span style="color:var(--danger)">WYDATEK: <span id="finExp">0</span></span>
      </div>
    </div>

    <div class="card mb-2">
      <div class="row cols2">
        <select id="finType" class="input">
          <option value="expense">ğŸ“‰ WYDATEK</option>
          <option value="income">ğŸ“ˆ PRZYCHÃ“D</option>
        </select>
        <input id="finDate" type="date" class="input">
      </div>
      <div class="row cols2">
        <input id="finAmount" type="number" placeholder="PLN" class="input">
        <input id="finDesc" type="text" placeholder="Opis (np. Cukier)" class="input">
      </div>
      <div class="mt-2">
        <button id="addFinBtn" class="btn btn-green w-full">DODAJ</button>
        <div class="small mt-2">Pozycje moÅ¼esz usuwaÄ‡.</div>
      </div>
    </div>

    <div id="finList" class="grid" style="gap:10px"></div>
  </section>

  <section id="viewInventory" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--slate)">
      <h3 style="margin:0 0 10px 0;font-weight:700">Magazyn (historia stanÃ³w)</h3>

      <div class="row cols2">
        <select id="invItemSel" class="input"></select>
        <input id="invNewName" type="text" placeholder="lub wpisz nowy produkt (np. Cukier)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveDate" type="date" class="input">
        <input id="invMoveDelta" type="number" step="0.01" placeholder="+ / âˆ’ iloÅ›Ä‡ (np. 25 lub -10)" class="input">
      </div>

      <div class="row cols2 mt-2">
        <input id="invMoveNote" type="text" placeholder="PowÃ³d (np. zakup, karmienie, produkcja)" class="input">
        <button id="invAddMoveBtn" class="btn btn-slate">DODAJ RUCH</button>
      </div>
      <div class="small mt-2">
        KaÅ¼dy wpis to ruch magazynowy z datÄ…. DziÄ™ki temu moÅ¼esz sprawdziÄ‡ stan na dowolny dzieÅ„.
      </div>
    </div>

    <div class="card mb-2" style="border-left:5px solid var(--blue)">
      <div class="muted mb-2">SPRAWDÅ¹ STAN NA DZIEÅƒ</div>
      <div class="row cols2">
        <select id="invQueryItem" class="input"></select>
        <input id="invQueryDate" type="date" class="input">
      </div>
      <button id="invQueryBtn" class="btn btn-blue w-full mt-2">POKAÅ»</button>
      <div id="invQueryResult" class="mt-2"></div>
    </div>

    <div class="card">
      <div class="muted mb-2">AKTUALNE STANY</div>
      <div id="invList" class="grid" style="gap:10px"></div>
    </div>
  </section>

  <section id="viewKnowledge" class="hidden">
    <div class="card mb-2" style="border-top:5px solid var(--purple)">
      <h3 style="margin:0 0 10px 0;font-weight:700">Wiedza (tematy)</h3>
      <div class="row cols2">
        <input id="knowNewTopic" type="text" placeholder="Nowy temat (np. OdkÅ‚ady)" class="input">
        <button id="addTopicBtn" class="btn" style="background:var(--purple)">DODAJ TEMAT</button>
      </div>
      <div class="row cols2">
        <select id="knowTopic" class="input"></select>
        <input id="knowTitle" type="text" placeholder="TytuÅ‚ notatki" class="input">
      </div>
      <textarea id="knowBody" placeholder="TreÅ›Ä‡..." class="input" style="height:90px"></textarea>
      <button id="addKnowBtn" class="btn w-full mt-2" style="background:var(--purple)">ZAPISZ NOTATKÄ˜</button>
      <div class="small mt-2">Notatki sÄ… pogrupowane wg tematu. Pozycje moÅ¼esz usuwaÄ‡.</div>
    </div>
    <div id="knowList" class="grid" style="gap:10px"></div>
  </section>
</main>


<div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="confirm-head">
      <div id="confirmTitle" class="confirm-title">POTWIERDÅ¹</div>
      <button id="confirmClose" class="btn btn-ghost" style="padding:6px 10px">âœ•</button>
    </div>
    <div class="confirm-body">
      <div id="confirmMessage" style="font-weight:700;font-size:16px"></div>
      <div id="confirmHint" class="small" style="margin-top:6px">Tej operacji nie da siÄ™ cofnÄ…Ä‡.</div>
    </div>
    <div class="confirm-foot">
      <button id="confirmCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="confirmOk" class="btn btn-red" style="padding:10px 14px">TAK, USUÅƒ</button>
    </div>
  </div>
</div>

<div id="addHiveOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true">
    <div class="confirm-head">
      <div class="confirm-title">NOWY UL</div>
      <button id="addHiveClose" class="btn btn-ghost" style="padding:6px 10px">âœ•</button>
    </div>
    <div class="confirm-body">
      <div class="row cols2">
        <input id="newHiveLabel" class="input" placeholder="Numer / nazwa (np. 12)">
        <input id="newHiveYear" class="input" type="number" placeholder="Rok">
      </div>
      <input id="newHivePlace" class="input mt-2" placeholder="PoÅ‚oÅ¼enie (np. RzÄ…d 1)">
      <select id="newHiveType" class="input mt-2">
        <option value="rodzina">Rodzina</option>
        <option value="odklad">OdkÅ‚ad</option>
      </select>
    </div>
    <div class="confirm-foot">
      <button id="addHiveCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="addHiveSave" class="btn btn-green" style="padding:10px 14px">ZAPISZ UL</button>
    </div>
  </div>
</div>

<div id="archiveHiveOverlay" class="confirm-overlay" aria-hidden="true">
  <div class="confirm-box" role="dialog" aria-modal="true">
    <div class="confirm-head">
      <div class="confirm-title">ARCHIWIZACJA / ÅÄ„CZENIE</div>
      <button id="archiveHiveClose" class="btn btn-ghost" style="padding:6px 10px">âœ•</button>
    </div>
    <div class="confirm-body">
      <div style="font-weight:700; margin-bottom:10px;">Z jakim ulem Å‚Ä…czysz tÄ™ rodzinÄ™?</div>
      <input id="archiveReason" class="input" placeholder="Np. PoÅ‚Ä…czono z ulem nr 5">
      <div class="small mt-2">Ul zostanie oznaczony jako "nieaktywny" i ukryty na gÅ‚Ã³wnym widoku (bÄ™dzie dostÄ™pny w filtrze "Archiwum").</div>
    </div>
    <div class="confirm-foot">
      <button id="archiveHiveCancel" class="btn btn-slate" style="padding:10px 14px">ANULUJ</button>
      <button id="archiveHiveConfirm" class="btn btn-blue" style="padding:10px 14px">ARCHIWIZUJ</button>
    </div>
  </div>
</div>


<script>
(() => {
  "use strict";

  /* ===== Helpers ===== */
  const $ = (id) => document.getElementById(id);

  // FIX: crypto moÅ¼e nie istnieÄ‡ (wtedy "crypto && ..." potrafi rzuciÄ‡ ReferenceError)
  const uid = () => (window.crypto && window.crypto.randomUUID)
    ? window.crypto.randomUUID()
    : (Date.now().toString(36) + Math.random().toString(36).slice(2));

  const esc = (s) =>
    String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");


  /* ===== Confirm (bez window.confirm) ===== */
  function confirmDialog({ title="POTWIERDÅ¹", message="", confirmText="TAK", confirmClass="btn-blue", hint="Tej operacji nie da siÄ™ cofnÄ…Ä‡." } = {}){
    return new Promise((resolve) => {
      const ov = $("confirmOverlay");
      const tt = $("confirmTitle");
      const msg = $("confirmMessage");
      const hintEl = $("confirmHint");
      const ok = $("confirmOk");
      const cancel = $("confirmCancel");
      const close = $("confirmClose");

      tt.textContent = title;
      msg.textContent = message;
      hintEl.textContent = hint || "";

      // ustaw przycisk OK
      ok.textContent = confirmText;
      ok.classList.remove("btn-blue","btn-green","btn-red","btn-slate","btn-orange");
      ok.classList.add(confirmClass);

      // pokaÅ¼
      ov.classList.add("show");
      ov.setAttribute("aria-hidden","false");

      const finish = (val) => {
        // sprzÄ…tanie listenerÃ³w
        ok.onclick = null;
        cancel.onclick = null;
        close.onclick = null;
        ov.onclick = null;

        ov.classList.remove("show");
        ov.setAttribute("aria-hidden","true");
        resolve(val);
      };

      ok.onclick = () => finish(true);
      cancel.onclick = () => finish(false);
      close.onclick = () => finish(false);
      ov.onclick = (e) => { if (e.target === ov) finish(false); };
    });
  }

  function confirmDelete(message){
    return confirmDialog({ title:"USUWANIE", message, confirmText:"TAK, USUÅƒ", confirmClass:"btn-red", hint:"Tej operacji nie da siÄ™ cofnÄ…Ä‡." });
  }

  const todayISO = () => new Date().toISOString().slice(0,10);

  /* ===== UI toast (zamiast alertÃ³w przeglÄ…darki) ===== */
  let __toastTimer = null;
  function notify(msg){
    const el = $("toast");
    if (!el) { console.warn(msg); return; }
    el.textContent = String(msg || "");
    el.classList.add("show");
    if (__toastTimer) clearTimeout(__toastTimer);
    __toastTimer = setTimeout(()=> el.classList.remove("show"), 2400);
  }

  const thisYear = new Date().getFullYear();

  const isoToPL = (iso) => {
    if (!iso) return "â€”";
    const [y,m,d] = String(iso).split("-");
    if (!y || !m || !d) return iso;
    return `${d}.${m}.${y}`;
  };

  const parseISODate = (iso) => {
    if (!iso) return null;
    const [y,m,d] = String(iso).split("-").map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m-1, d, 12, 0, 0, 0);
  };

  const monthsDiff = (y1,m1,y2,m2) => (y2*12 + (m2-1)) - (y1*12 + (m1-1));

  /* ===== IndexedDB ===== */
  const DB_NAME = "pasiecznik_ultra_db";
  const DB_VER  = 11; // bump: visual refresh + avoid downgrade errors
  let db = null;

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains("data")) d.createObjectStore("data", { keyPath:"key" });
      };
      req.onsuccess = () => { db = req.result; resolve(db); };
      req.onerror = () => reject(req.error);
    });
  }

  function dbGet(key){
    return new Promise((resolve) => {
      const tx = db.transaction("data","readonly");
      const req = tx.objectStore("data").get(key);
      req.onsuccess = () => resolve(req.result ? req.result.value : null);
      req.onerror = () => resolve(null);
    });
  }

  function dbSet(key, value){
    return new Promise((resolve, reject) => {
      const tx = db.transaction("data","readwrite");
      tx.objectStore("data").put({ key, value });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /* ===== State ===== */
  const State = {
    view: "hives",
    currentHive: null,

    hives: [],
    reviews: [],
    queens: [],
    feedings: [],
    treatments: [],
    harvests: [],

    calendar: {},
    finance: [],
    invItems: [],
    invMoves: [],

    topics: [],
    knowledge: []
  };

  async function loadAll(){
    State.hives     = (await dbGet("hives"))     || [];
    State.reviews   = (await dbGet("reviews"))   || [];
    State.queens    = (await dbGet("queens"))    || [];
    State.feedings  = (await dbGet("feedings"))  || [];
    State.treatments = (await dbGet("treatments")) || [];
    State.harvests  = (await dbGet("harvests"))  || [];
    State.calendar  = (await dbGet("calendar"))  || {};
    State.finance   = (await dbGet("finance"))   || [];
    State.invItems  = (await dbGet("invItems"))  || [];
    State.invMoves  = (await dbGet("invMoves"))  || [];
    State.topics    = (await dbGet("topics"))    || ["OgÃ³lne"];
    State.knowledge = (await dbGet("knowledge")) || [];

    if (!State.hives.length){
      State.hives = ["1","2","3"].map(s => ({
        id: s, label: s, place: "", kind: "rodzina", year: thisYear, nextVisitDate: "", isArchived: false
      }));
      await dbSet("hives", State.hives);
    }

    State.hives.forEach(h => {
      if (h.label == null) h.label = h.id;
      if (h.place == null) h.place = "";
      if (h.kind == null) h.kind = "rodzina";
      if (h.year == null) h.year = thisYear;
      if (h.nextVisitDate == null) h.nextVisitDate = "";
      if (h.isArchived == null) h.isArchived = false;
    });
  }

  async function save(key){ await dbSet(key, State[key]); }

  /* ===== Router ===== */
  function hideAll(){
    document.querySelectorAll("main > section").forEach(s => s.classList.add("hidden"));
  }

  function setTitle(){
    const v = State.view;
    $("backBtn").classList.toggle("hidden", v !== "details");
    const map = {
      hives:"PASIECZNIK",
      details:"UL",
      calendar:"KALENDARZ",
      finance:"FINANSE",
      inventory:"MAGAZYN",
      knowledge:"WIEDZA"
    };
    $("appTitle").textContent =
      (v === "details" && State.currentHive) ? ("UL " + State.currentHive) : (map[v] || "PASIECZNIK");
  }

  function renderView(view, hiveId=null, push=true){
    State.view = view;
    State.currentHive = hiveId;

    hideAll();
    const secId = "view" + view.charAt(0).toUpperCase() + view.slice(1);
    const sec = $(secId);
    if (sec) sec.classList.remove("hidden");
    setTitle();

    if (view === "hives") renderHives();
    if (view === "details") renderDetails();
    if (view === "calendar") renderCalendar();
    if (view === "finance") renderFinance();
    if (view === "inventory") renderInventory();
    if (view === "knowledge") renderKnowledge();

    if (push){
      const p = new URLSearchParams();
      p.set("v", view);
      if (view === "details" && hiveId) p.set("id", hiveId);
      history.pushState({view, hiveId}, "", "?" + p.toString());
    }
  }

  window.onpopstate = (e) => {
    const st = e.state;
    if (st && st.view){
      renderView(st.view, st.hiveId || null, false);
      return;
    }
    const p = new URLSearchParams(location.search);
    const v = p.get("v") || "hives";
    const id = p.get("id");
    renderView(v, v === "details" ? id : null, false);
  };

  /* ===== Computed ===== */
  function lastReviewForHive(hiveId){
    const rs = State.reviews
      .filter(r => r.hiveId === hiveId && r.visitDate)
      .sort((a,b) => (b.visitDate||"").localeCompare(a.visitDate||"") || (b.ts||0)-(a.ts||0));
    return rs[0] || null;
  }

  function lastReviewDateForHive(hiveId){
    return lastReviewForHive(hiveId)?.visitDate || "";
  }

  function needsReview(hive){
    const t = todayISO();
    if (hive.nextVisitDate) return hive.nextVisitDate <= t;
    const last = lastReviewDateForHive(hive.id);
    if (!last) return true;
    const lastDt = parseISODate(last);
    const now = parseISODate(t);
    const diffDays = Math.floor((now - lastDt) / (1000*60*60*24));
    return diffDays >= 6;
  }

  function currentQueenForHive(hiveId){
    const qs = State.queens.filter(q => q.hiveId === hiveId);
    const current = qs.find(q => q.isCurrent);
    if (current) return current;
    return qs.sort((a,b)=>(b.ts||0)-(a.ts||0))[0] || null;
  }

  function queenNeedsChange(hiveId){
    const q = currentQueenForHive(hiveId);
    if (!q || !q.year || !q.month) return false;
    const now = new Date();
    const ageM = monthsDiff(Number(q.year), Number(q.month), now.getFullYear(), now.getMonth()+1);
    return ageM >= 24;
  }

  /* ===== Filters ===== */
  const Filters = { review:false, queen:false, archived:false };
  function applyFilterFlags(btn, isOn, style){
    btn.classList.toggle("active", !!isOn);
    if (style==="red") btn.classList.toggle("active-red", !!isOn);
    if (style==="slate") btn.classList.toggle("active-slate", !!isOn);
  }
  function renderFilterButtons(){
    applyFilterFlags($("fltReviewBtn"), Filters.review);
    applyFilterFlags($("fltQueenBtn"), Filters.queen, "red");
    applyFilterFlags($("fltArchivedBtn"), Filters.archived, "slate");
  }
  function filterHives(list){
    let out = [...list];
    
    // ARCHIVE LOGIC
    if (Filters.archived) {
        out = out.filter(h => h.isArchived === true);
    } else {
        out = out.filter(h => !h.isArchived); // show only active by default
    }

    if (Filters.review) out = out.filter(h => needsReview(h));
    if (Filters.queen) out = out.filter(h => queenNeedsChange(h.id));
    return out;
  }

  /* ===== Render: Hives ===== */
  function renderHives(){
    renderFilterButtons();
    const grid = $("hivesGrid");
    grid.innerHTML = "";

    const sorted = [...State.hives].sort((a,b) =>
      String(a.label).localeCompare(String(b.label), undefined, {numeric:true})
    );
    const filtered = filterHives(sorted);

    filtered.forEach(h => {
      const due = needsReview(h);
      const lastRev = lastReviewDateForHive(h.id);

      const q = currentQueenForHive(h.id);
      const qChange = queenNeedsChange(h.id);
      const now = new Date();
      const qAgeM = (q && q.year && q.month)
        ? monthsDiff(Number(q.year), Number(q.month), now.getFullYear(), now.getMonth()+1)
        : null;
      const qName = (q && q.name) ? String(q.name) : "brak";
      
      const isArch = !!h.isArchived;

      // LOGIKA FORMATOWANIA WIEKU (LATA + MIESIÄ„CE)
      let ageStr = "";
      if (qAgeM !== null) {
          if (qAgeM < 12) {
              ageStr = ` â€¢ ${qAgeM} mies.`;
          } else {
              const y = Math.floor(qAgeM / 12);
              const m = qAgeM % 12;
              ageStr = ` â€¢ ${y} l. ${m} mies.`;
          }
      }

      const el = document.createElement("div");
      el.className = "card hive-card" + (isArch ? " archived" : "");
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div style="font-size:22px;font-weight:700">${esc(h.label)} ${isArch ? "(ARCH)" : ""}</div>
            <div class="small" style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
              <span class="pill">${h.kind==="odklad"?"OdkÅ‚ad":"Rodzina"} ${esc(h.year)}</span>
              ${h.place ? `<span class="pill">ğŸ“ ${esc(h.place)}</span>` : ``}
              ${
                h.nextVisitDate && !isArch
                  ? `<span class="pill" style="border-color:${due?'#fecaca':'var(--border)'}">â­ NastÄ™pny przeglÄ…d: ${esc(isoToPL(h.nextVisitDate))}</span>`
                  : (due && !isArch ? `<span class="pill" style="border-color:#fecaca">â­ NastÄ™pny przeglÄ…d: BRAK</span>` : ``)
              }
              <span class="pill" style="border-color:${qChange?'#fecaca':'var(--border)'}">ğŸ‘‘ ${esc(qName)}${ageStr}</span>
              ${qChange && !isArch ? `<span class="pill" style="border-color:#fecaca">ğŸ‘‘ âš  DO WYMIANY</span>` : ``}
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">Ostatni przeglÄ…d</div>
            <div style="font-weight:700">${lastRev ? isoToPL(lastRev) : "â€”"}</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:12px">
          ${isArch 
            ? `<div style="color:var(--slate);font-weight:700">ğŸ—„ï¸ ZARCHIWIZOWANY</div>`
            : `<div class="${due?'text-alert':''}" style="margin-top:6px;font-weight:700">${due ? "ğŸ” DO PRZEGLÄ„DU" : "âœ… OK"}</div>`
          }
        </div>
      `;
      el.addEventListener("click", () => renderView("details", h.id, true));
      grid.appendChild(el);
    });

    if (!filtered.length){
      const empty = document.createElement("div");
      empty.className = "card text-center";
      empty.innerHTML = `
        <div style="font-weight:700">${Filters.archived ? "Brak uli w archiwum." : "Brak aktywnych uli."}</div>
        <div class="small mt-2">${Filters.archived ? "" : "Dodaj ul przyciskiem + UL."}</div>
      `;
      grid.appendChild(empty);
    }
  }

  /* ===== Details ===== */
  let editReviewId = null;
  let editFeedId = null;
  let editTreatId = null;
  let editQueenId = null;
  let editHarvId = null;

  function renderDetails(){
    const hiveId = State.currentHive;
    const hive = State.hives.find(h => h.id === hiveId);
    if (!hive){ renderView("hives", null, true); return; }

    $("detailsTitle").textContent = `${hive.label} â€¢ ${hive.kind==="odklad"?"OdkÅ‚ad":"Rodzina"} â€¢ ${hive.year}`;

    $("hLabel").value = hive.label || hive.id || "";
    $("hPlace").value = hive.place || "";
    $("hType").value  = hive.kind || "rodzina";
    $("hYear").value  = hive.year || thisYear;
    $("hNextVisit").value = hive.nextVisitDate || "";
    
    // ARCHIVE LOGIC
    if (hive.isArchived) {
        $("archiveHiveBtn").textContent = "PRZYWRÃ“Ä† UL (AKTYWUJ)";
        $("saveHiveMetaBtn").textContent = "ZAPISZ (UL ARCHIWALNY)";
        $("detailsTitle").textContent += " (ARCH)";
    } else {
        $("archiveHiveBtn").textContent = "ğŸ“¦ ARCHIWIZUJ / POÅÄ„CZ";
        $("saveHiveMetaBtn").textContent = "ZAPISZ METADANE ULA";
    }

    // FIX: nie resetuj pÃ³l w trakcie edycji
    if (!editReviewId){
      $("revDate").value = todayISO();
      $("revNext").value = hive.nextVisitDate || "";
      $("revNote").value = "";
    } else {
      if (!$("revDate").value) $("revDate").value = todayISO();
      if ($("revNext").value == null) $("revNext").value = hive.nextVisitDate || "";
    }

    if (!editFeedId){
      $("feedDate").value = todayISO();
      $("feedType").value = "syrop";
      $("feedQty").value = "";
      $("feedNote").value = "";
    } else {
      if (!$("feedDate").value) $("feedDate").value = todayISO();
    }

    if (!editQueenId){
      $("qName").value="";
      $("qYear").value=thisYear;
      $("qMonth").value=new Date().getMonth()+1;
      $("qMating").value="";
      $("qLine").value="";
      $("qOpalit").value="";
      $("qGentle").value="";
      $("qNote").value="";
    }

    if (!editHarvId){
      $("harvDate").value = todayISO();
      $("harvType").value="";
      $("harvKg").value="";
    } else {
      if (!$("harvDate").value) $("harvDate").value = todayISO();
    }

    renderReviews();
    renderFeedings();
    renderTreatments();
    renderQueens();
    renderHarvests();
  }

  async function saveHiveMeta(){
    const oldId = State.currentHive;
    const hive = State.hives.find(h => h.id === oldId);
    if (!hive) return;

    const newLabel = ($("hLabel").value || "").trim();
    const newPlace = ($("hPlace").value || "").trim();
    const newNext  = ($("hNextVisit").value || "").trim();

    if (!newLabel) return notify("Numer / nazwa ula nie moÅ¼e byÄ‡ pusta.");

    const newId = newLabel;
    if (newId !== oldId && State.hives.some(h => h.id === newId)){
      return notify("Taki numer/nazwa ula juÅ¼ istnieje. Wpisz inny.");
    }

    hive.kind  = $("hType").value;
    hive.year  = Number($("hYear").value) || thisYear;
    hive.place = newPlace;
    hive.nextVisitDate = newNext;

    if (newId !== oldId){
      hive.id = newId;
      hive.label = newLabel;

      State.reviews.forEach(r => { if (r.hiveId === oldId) r.hiveId = newId; });
      State.queens.forEach(q => { if (q.hiveId === oldId) q.hiveId = newId; });
      State.feedings.forEach(f => { if (f.hiveId === oldId) f.hiveId = newId; });
      State.treatments.forEach(tr => { if (tr.hiveId === oldId) tr.hiveId = newId; });


    State.treatments.forEach(tr => {
      if (!tr.id) tr.id = uid();
      if (!tr.ts) tr.ts = Date.now();
      if (tr.type == null) tr.type = "";
      if (tr.qty == null) tr.qty = "";
    });
      State.harvests.forEach(x => { if (x.hiveId === oldId) x.hiveId = newId; });

      await save("reviews"); await save("queens"); await save("feedings"); await save("harvests");

      State.currentHive = newId;
      const p = new URLSearchParams(location.search);
      p.set("v","details"); p.set("id", newId);
      history.replaceState({view:"details", hiveId:newId}, "", "?" + p.toString());
    } else {
      hive.label = newLabel;
    }

    await save("hives");
    renderDetails();
    renderHives();
  }

  /* ===== Reviews ===== */
  function renderReviews(){
    const hiveId = State.currentHive;
    const list = $("revList");
    list.innerHTML = "";

    const items = State.reviews.filter(r => r.hiveId === hiveId)
      .sort((a,b) => (b.visitDate||"").localeCompare(a.visitDate||"") || (b.ts||0)-(a.ts||0));

    $("reviewsCount").textContent = String(items.length);

    items.forEach(r => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid " + (r.nextVisitDate && r.nextVisitDate <= todayISO() ? "var(--danger)" : "var(--blue)");
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:700">${isoToPL(r.visitDate)} ${r.nextVisitDate?`â€¢ â­ ${isoToPL(r.nextVisitDate)}`:""}</div>
            <div style="white-space:pre-wrap;margin-top:6px">${esc(r.note||"")}</div>
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-act="revEdit" data-id="${esc(r.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-act="revDel" data-id="${esc(r.id)}">USUÅƒ</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });

    State.treatments.forEach(t => {
      if (!t.id) t.id = uid();
      if (!t.ts) t.ts = Date.now();
      if (t.type == null) t.type = "";
      if (t.qty == null) t.qty = "";
      if (t.date == null) t.date = "";
    });

  }

  async function saveReview(){
    const hiveId = State.currentHive;
    const visitDate = $("revDate").value || todayISO();
    const nextVisitDate = ($("revNext").value || "").trim();
    const note = ($("revNote").value || "").trim();

    if (!visitDate) return notify("Podaj datÄ™ przeglÄ…du.");

    if (editReviewId){
      const r = State.reviews.find(x => x.id === editReviewId);
      if (!r) { editReviewId=null; return; }
      r.visitDate = visitDate;
      r.nextVisitDate = nextVisitDate;
      r.note = note;
      r.ts = Date.now();
    } else {
      State.reviews.push({ id:uid(), hiveId, visitDate, nextVisitDate, note, ts:Date.now() });
    }

    const hive = State.hives.find(h => h.id === hiveId);
    if (hive) hive.nextVisitDate = nextVisitDate || "";

    await save("reviews");
    await save("hives");

    editReviewId = null;
    $("revNote").value = "";
    $("revDate").value = todayISO();
    $("revNext").value = "";
    renderReviews();
    renderHives();
  }

  function startEditReview(id){
    const r = State.reviews.find(x => x.id === id);
    if (!r) return;
    editReviewId = id;
    $("revDate").value = r.visitDate || todayISO();
    $("revNext").value = r.nextVisitDate || "";
    $("revNote").value = r.note || "";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function deleteReview(id){
    if (!await confirmDelete("UsunÄ…Ä‡ przeglÄ…d?")) return;
    State.reviews = State.reviews.filter(x => x.id !== id);
    await save("reviews");
    editReviewId = null;
    $("revNote").value = "";
    $("revDate").value = todayISO();
    renderReviews();
    renderHives();
  }

  /* ===== Feedings ===== */
  function renderFeedings(){
    const hiveId = State.currentHive;
    const list = $("feedList");
    list.innerHTML = "";

    const items = State.feedings.filter(f => f.hiveId === hiveId)
      .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0));

    $("feedCount").textContent = String(items.length);

    items.forEach(f => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--slate)";
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:700">${isoToPL(f.date)} â€¢ ${esc(f.type||"")}</div>
            <div class="small">IloÅ›Ä‡: <b>${Number(f.qty||0).toFixed(2)}</b> (kg/l)</div>
            ${f.note ? `<div style="white-space:pre-wrap;margin-top:6px">${esc(f.note)}</div>` : ``}
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-act="feedEdit" data-id="${esc(f.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-act="feedDel" data-id="${esc(f.id)}">USUÅƒ</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  async function saveFeeding(){
    const hiveId = State.currentHive;
    const date = $("feedDate").value || todayISO();
    const type = $("feedType").value || "syrop";
    const qty = Number($("feedQty").value);
    const note = ($("feedNote").value || "").trim();

    if (!Number.isFinite(qty) || qty === 0) return notify("Podaj iloÅ›Ä‡ (rÃ³Å¼nÄ… od 0).");

    if (editFeedId){
      const f = State.feedings.find(x => x.id === editFeedId);
      if (!f) { editFeedId=null; return; }
      f.date = date; f.type = type; f.qty = qty; f.note = note; f.ts = Date.now();
    } else {
      State.feedings.push({ id:uid(), hiveId, date, type, qty, note, ts:Date.now() });
    }

    await save("feedings");
    clearFeedingEdit();
    $("feedDate").value = todayISO();
    renderFeedings();
  }

  function startEditFeeding(id){
    const f = State.feedings.find(x => x.id === id);
    if (!f) return;
    editFeedId = id;
    $("feedDate").value = f.date || todayISO();
    $("feedType").value = f.type || "syrop";
    $("feedQty").value = f.qty ?? "";
    $("feedNote").value = f.note || "";
  }

  function clearFeedingEdit(){
    editFeedId = null;
    $("feedType").value = "syrop";
    $("feedQty").value = "";
    $("feedNote").value = "";
  }

  async function deleteFeeding(id){
    if (!await confirmDelete("UsunÄ…Ä‡ karmienie?")) return;
    State.feedings = State.feedings.filter(x => x.id !== id);
    await save("feedings");
    clearFeedingEdit();
    $("feedDate").value = todayISO();
    renderFeedings();
  }


  /* ===== Treatments ===== */
  function renderTreatments(){
    const hiveId = State.currentHive;
    const list = $("treatList");
    const cnt = $("treatCount");
    if (!list) return;
    list.innerHTML = "";

    const items = State.treatments
      .filter(t => t.hiveId === hiveId)
      .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0));

    if (cnt) cnt.textContent = items.length ? (items.length + " wpis.") : "0";

    if (!items.length){
      list.innerHTML = `<div class="card text-center"><div style="font-weight:700">Brak leczeÅ„.</div><div class="small mt-2">Dodaj pierwszy wpis leczenia powyÅ¼ej.</div></div>`;
      return;
    }

    items.forEach(t => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--danger)";
      el.innerHTML = `
        <div class="kv">
          <div>
            <div style="font-weight:700">ğŸ’Š ${isoToPL(t.date)} â€¢ ${esc(t.type||"â€”")}</div>
            <div class="small" style="margin-top:6px">IloÅ›Ä‡: <b>${esc(t.qty||"â€”")}</b></div>
          </div>
          <div class="flex gap-1" style="justify-content:flex-end;flex-wrap:wrap">
            <button class="btn btn-blue tinybtn" data-act="editTreat" data-id="${esc(t.id)}">EDYTUJ</button>
            <button class="btn btn-slate tinybtn" data-act="delTreat" data-id="${esc(t.id)}">USUÅƒ</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  
  /* ===== Leczenie (formularz: dodaj / edytuj) ===== */
  async function addTreatment(){
    const hiveId = State.currentHive;
    const date = ($("treatDate").value || "").trim();
    const type = ($("treatType").value || "").trim();
    const qty  = ($("treatQty").value || "").trim();

    if (!date) return notify("Podaj datÄ™ leczenia.");
    if (!type) return notify("Podaj rodzaj leku/Å›rodka.");
    if (!qty)  return notify("Podaj iloÅ›Ä‡.");

    if (editTreatId){
      const t = State.treatments.find(x => x.id === editTreatId);
      if (t){
        t.date = date;
        t.type = type;
        t.qty  = qty;
        t.ts   = Date.now();
      }
      editTreatId = null;

      const btn = $("treatSaveBtn");
      btn.textContent = "ZAPISZ LECZENIE";
      btn.classList.remove("btn-blue");
      btn.classList.add("btn-red");
    } else {
      State.treatments.push({ id:uid(), hiveId, date, type, qty, ts:Date.now() });
    }

    await save("treatments");

    $("treatType").value = "";
    $("treatQty").value = "";
    renderTreatments();
  }

  function startEditTreatment(id){
    const t = State.treatments.find(x => x.id === id);
    if (!t) return;
    editTreatId = id;

    $("treatDate").value = t.date || todayISO();
    $("treatType").value = t.type || "";
    $("treatQty").value  = t.qty  || "";

    const btn = $("treatSaveBtn");
    btn.textContent = "ZAPISZ ZMIANY";
    btn.classList.remove("btn-red");
    btn.classList.add("btn-blue");

    const details = $("treatList")?.closest("details");
    if (details) details.open = true;
  }

  async function deleteTreatment(id){
    if (!await confirmDelete("UsunÄ…Ä‡ wpis leczenia?")) return;
    State.treatments = State.treatments.filter(t => t.id !== id);
    await save("treatments");

    // jeÅ›li usuwaÅ‚aÅ› wÅ‚aÅ›nie edytowany wpis, wyjdÅº z trybu edycji
    if (editTreatId === id){
      editTreatId = null;
      const btn = $("treatSaveBtn");
      if (btn){
        btn.textContent = "ZAPISZ LECZENIE";
        btn.classList.remove("btn-blue");
        btn.classList.add("btn-red");
      }
    }

    renderTreatments();
    renderHives();
  }

/* ===== Queens ===== */
  function renderQueens(){
    const hiveId = State.currentHive;
    const list = $("queenList");
    list.innerHTML = "";

    const items = State.queens.filter(q => q.hiveId === hiveId)
      .sort((a,b) => (b.isCurrent?1:0)-(a.isCurrent?1:0) || (b.ts||0)-(a.ts||0));

    $("queenCount").textContent = String(items.length);

    const now = new Date();
    items.forEach(q => {
      const ageM = (q.year && q.month) ? monthsDiff(Number(q.year), Number(q.month), now.getFullYear(), now.getMonth()+1) : null;
      const warn = (ageM != null && ageM >= 24);
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid " + (warn ? "var(--danger)" : "var(--purple)");
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:700">
              ${q.isCurrent ? "âœ… AKTUALNA â€¢ " : ""}${esc(q.name||"(bez nazwy)")}
              ${q.year?` â€¢ ${esc(q.year)}/${String(q.month||"").padStart(2,"0")}`:""}
            </div>
            <div class="small">
              ${ageM!=null ? `Wiek: <b>${ageM}</b> mies.` : "Wiek: â€”"}
              ${warn ? ` â€¢ <span style="color:var(--danger);font-weight:700">MATKA DO WYMIANY</span>` : ``}
            </div>
            <div class="small" style="margin-top:6px">
              ${q.mating?`Unasiennianie: <b>${esc(q.mating)}</b> â€¢ `:""}
              ${q.line?`Linia/Hodowca: <b>${esc(q.line)}</b> â€¢ `:""}
              ${q.opalit?`Opalitka: <b>${esc(q.opalit)}</b>`:""}
            </div>
            ${q.gentle?`<div class="small">ÅagodnoÅ›Ä‡: <b>${esc(q.gentle)}</b></div>`:""}
            ${q.note?`<div style="white-space:pre-wrap;margin-top:6px">${esc(q.note)}</div>`:""}
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-blue" style="padding:6px 10px" data-act="queenSetCurrent" data-id="${esc(q.id)}">USTAW AKTUALNÄ„</button>
            <button class="btn btn-slate" style="padding:6px 10px" data-act="queenEdit" data-id="${esc(q.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-act="queenDel" data-id="${esc(q.id)}">USUÅƒ</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  async function saveQueen(){
    const hiveId = State.currentHive;
    const name = ($("qName").value || "").trim();
    const year = Number($("qYear").value);
    const month = Number($("qMonth").value);
    const mating = ($("qMating").value || "").trim();
    const line = ($("qLine").value || "").trim();
    const opalit = ($("qOpalit").value || "").trim();
    const gentle = ($("qGentle").value || "").trim();
    const note = ($("qNote").value || "").trim();

    if (!name && (!Number.isFinite(year) || !Number.isFinite(month))) return notify("Podaj nazwÄ™ lub rocznik+miesiÄ…c.");
    if (month && (month < 1 || month > 12)) return notify("MiesiÄ…c 1-12.");

    if (editQueenId){
      const q = State.queens.find(x => x.id === editQueenId);
      if (!q) { editQueenId=null; return; }
      q.name = name || q.name;
      q.year = Number.isFinite(year) ? year : q.year;
      q.month = Number.isFinite(month) ? month : q.month;
      q.mating = mating; q.line = line; q.opalit = opalit; q.gentle = gentle; q.note = note;
      q.ts = Date.now();
    } else {
      State.queens.push({
        id:uid(), hiveId,
        name: name || "(bez nazwy)",
        year: Number.isFinite(year) ? year : null,
        month: Number.isFinite(month) ? month : null,
        mating, line, opalit, gentle, note,
        isCurrent: false,
        ts: Date.now()
      });
    }

    await save("queens");
    clearQueenEdit();
    renderQueens();
    renderHives();
  }

  function startEditQueen(id){
    const q = State.queens.find(x => x.id === id);
    if (!q) return;
    editQueenId = id;
    $("qName").value = q.name || "";
    $("qYear").value = q.year ?? "";
    $("qMonth").value = q.month ?? "";
    $("qMating").value = q.mating || "";
    $("qLine").value = q.line || "";
    $("qOpalit").value = q.opalit || "";
    $("qGentle").value = q.gentle || "";
    $("qNote").value = q.note || "";
  }

  function clearQueenEdit(){
    editQueenId = null;
    $("qName").value="";
    $("qYear").value=thisYear;
    $("qMonth").value=new Date().getMonth()+1;
    $("qMating").value="";
    $("qLine").value="";
    $("qOpalit").value="";
    $("qGentle").value="";
    $("qNote").value="";
  }

  async function deleteQueen(id){
    if (!await confirmDelete("UsunÄ…Ä‡ wpis o matce?")) return;
    State.queens = State.queens.filter(x => x.id !== id);
    await save("queens");
    clearQueenEdit();
    renderQueens();
    renderHives();
  }

  async function setCurrentQueen(id){
    const hiveId = State.currentHive;
    State.queens.forEach(q => { if (q.hiveId === hiveId) q.isCurrent = (q.id === id); });
    await save("queens");
    renderQueens();
    renderHives();
  }

  /* ===== Harvests ===== */
  function renderHarvests(){
    const hiveId = State.currentHive;
    const list = $("harvList");
    list.innerHTML = "";

    const items = State.harvests.filter(x => x.hiveId === hiveId)
      .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0));

    $("harvCount").textContent = String(items.length);

    items.forEach(h => {
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--orange)";
      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:700">${isoToPL(h.date)} â€¢ ${esc(h.type||"")}</div>
            <div class="small">IloÅ›Ä‡: <b>${Number(h.kg||0).toFixed(2)}</b> kg</div>
          </div>
          <div class="flex gap-2" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-act="harvEdit" data-id="${esc(h.id)}">EDYTUJ</button>
            <button class="btn btn-red" style="padding:6px 10px" data-act="harvDel" data-id="${esc(h.id)}">USUÅƒ</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  async function saveHarvest(){
    const hiveId = State.currentHive;
    const date = $("harvDate").value || todayISO();
    const type = ($("harvType").value || "").trim();
    const kg = Number($("harvKg").value);

    if (!date) return notify("Podaj datÄ™.");
    if (!type) return notify("Podaj rodzaj miodu.");
    if (!Number.isFinite(kg) || kg <= 0) return notify("Podaj iloÅ›Ä‡ > 0.");

    if (editHarvId){
      const h = State.harvests.find(x => x.id === editHarvId);
      if (!h) { editHarvId=null; return; }
      h.date=date; h.type=type; h.kg=kg; h.ts=Date.now();
    } else {
      State.harvests.push({ id:uid(), hiveId, date, type, kg, ts:Date.now() });
    }

    await save("harvests");
    clearHarvestEdit();
    $("harvDate").value = todayISO();
    renderHarvests();
  }

  function startEditHarvest(id){
    const h = State.harvests.find(x => x.id === id);
    if (!h) return;
    editHarvId = id;
    $("harvDate").value = h.date || todayISO();
    $("harvType").value = h.type || "";
    $("harvKg").value = h.kg ?? "";
  }

  function clearHarvestEdit(){
    editHarvId = null;
    $("harvType").value="";
    $("harvKg").value="";
  }

  async function deleteHarvest(id){
    if (!await confirmDelete("UsunÄ…Ä‡ miodobranie?")) return;
    State.harvests = State.harvests.filter(x => x.id !== id);
    await save("harvests");
    clearHarvestEdit();
    $("harvDate").value = todayISO();
    renderHarvests();
  }

  /* ===== Calendar ===== */
  function ensureCalendarYear(y){ if (!State.calendar[y]) State.calendar[y] = {}; }

  function renderCalendar(){
    const months = ["StyczeÅ„","Luty","Marzec","KwiecieÅ„","Maj","Czerwiec","Lipiec","SierpieÅ„","WrzesieÅ„","PaÅºdziernik","Listopad","GrudzieÅ„"];
    const yearSel = $("calYear");

    if (!yearSel.options.length){
      for (let y=2022;y<=2029;y++){
        const o=document.createElement("option");
        o.value=String(y); o.textContent=String(y);
        yearSel.appendChild(o);
      }
    }

    const current = yearSel.value || String(thisYear);
    yearSel.value = (Number(current)>=2022 && Number(current)<=2029) ? current : String(thisYear);

    ensureCalendarYear(yearSel.value);

    const grid = $("calendarGrid");
    grid.innerHTML = "";

    months.forEach((m,idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div style="font-weight:700;color:var(--success);margin-bottom:6px">${m} ${yearSel.value}</div>`;
      const area = document.createElement("textarea");
      area.className="input";
      area.style.height="75px";
      area.value = State.calendar[yearSel.value][idx] || "";
      area.addEventListener("change", async (e) => {
        ensureCalendarYear(yearSel.value);
        State.calendar[yearSel.value][idx] = e.target.value;
        await save("calendar");
      });
      card.appendChild(area);
      grid.appendChild(card);
    });

    yearSel.onchange = () => renderCalendar();
  }

  /* ===== Finance ===== */
  function renderFinance(){
    const list = $("finList");
    list.innerHTML = "";

    let inc=0, exp=0;
    const items = [...State.finance].sort((a,b) => (b.date||"").localeCompare(a.date||""));

    items.forEach(f => {
      if (f.type === "income") inc += Number(f.amount||0);
      else exp += Number(f.amount||0);

      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid " + (f.type==="income" ? "var(--success)" : "var(--danger)");
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div style="font-weight:700">${esc(f.desc)}</div>
            <div class="small">${isoToPL(f.date)} â€¢ ${f.type==="income"?"PrzychÃ³d":"Wydatek"}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700;color:${f.type==="income"?"var(--success)":"var(--danger)"}">
              ${f.type==="income"?"+":"-"}${Number(f.amount||0).toFixed(2)} zÅ‚
            </div>
            <div class="flex gap-2" style="justify-content:flex-end;margin-top:8px">
              <button class="btn btn-slate" style="padding:6px 10px" data-act="finDel" data-id="${esc(f.id)}">USUÅƒ</button>
            </div>
          </div>
        </div>
      `;
      list.appendChild(el);
    });

    $("finInc").textContent = inc.toFixed(2);
    $("finExp").textContent = exp.toFixed(2);
    const bal = inc-exp;
    $("finBalance").textContent = bal.toFixed(2) + " PLN";
    $("finBalance").style.color = bal>=0 ? "var(--success)" : "var(--danger)";
  }

  async function addFinance(){
    const type = $("finType").value;
    const date = $("finDate").value || todayISO();
    const amount = Number($("finAmount").value);
    const desc = ($("finDesc").value || "").trim();

    if (!desc || !Number.isFinite(amount) || amount<=0) return notify("Podaj opis i kwotÄ™ > 0.");

    State.finance.push({ id:uid(), type, date, amount, desc });
    await save("finance");

    $("finAmount").value = "";
    $("finDesc").value = "";
    renderFinance();
  }

  async function deleteFinance(id){
    if (!await confirmDelete("UsunÄ…Ä‡ wpis w finansach?")) return;
    State.finance = State.finance.filter(x => x.id !== id);
    await save("finance");
    renderFinance();
  }

  /* ===== Inventory ===== */
  function invCalcQtyAtDate(itemId, isoDate){
    const d = isoDate || todayISO();
    return State.invMoves
      .filter(m => m.itemId === itemId && (m.date||"") <= d)
      .reduce((s,m) => s + (Number(m.delta)||0), 0);
  }

  function invCalcCurrentQty(itemId){
    return State.invMoves
      .filter(m => m.itemId === itemId)
      .reduce((s,m) => s + (Number(m.delta)||0), 0);
  }

  function refreshInvSelectors(){
    const items = [...State.invItems].sort((a,b) => String(a.name).localeCompare(String(b.name)));
    const sel  = $("invItemSel");
    const qsel = $("invQueryItem");

    sel.innerHTML  = `<option value="">Wybierz produktâ€¦</option>`;
    qsel.innerHTML = `<option value="">Wybierz produktâ€¦</option>`;

    items.forEach(it => {
      const o=document.createElement("option");
      o.value=it.id; o.textContent=it.name;
      sel.appendChild(o);

      const o2=document.createElement("option");
      o2.value=it.id; o2.textContent=it.name;
      qsel.appendChild(o2);
    });
  }

  function renderInventory(){
    refreshInvSelectors();
    $("invMoveDate").value  = $("invMoveDate").value  || todayISO();
    $("invQueryDate").value = $("invQueryDate").value || todayISO();

    const list = $("invList");
    list.innerHTML = "";

    const items = [...State.invItems].sort((a,b) => String(a.name).localeCompare(String(b.name)));
    if (!items.length){
      list.innerHTML = `
        <div class="card text-center">
          <div style="font-weight:700">Brak produktÃ³w w magazynie.</div>
          <div class="small mt-2">Dodaj pierwszy ruch (np. zakup).</div>
        </div>
      `;
      return;
    }

    for (const it of items){
      const qty = invCalcCurrentQty(it.id);
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderLeft = "4px solid var(--slate)";

      const lastMoves = State.invMoves
        .filter(m => m.itemId === it.id)
        .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0))
        .slice(0,6);

      el.innerHTML = `
        <div class="flex justify-between items-center" style="gap:10px">
          <div style="flex:1">
            <div style="font-weight:700">${esc(it.name)}</div>
            <div class="small">Aktualnie: <b>${qty.toFixed(2)}</b></div>
          </div>
          <div class="flex gap-2 items-center" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-slate" style="padding:6px 10px" data-act="invDelItem" data-id="${esc(it.id)}">USUÅƒ</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="small">Ostatnie ruchy:</div>
        <div style="display:grid;gap:6px;margin-top:8px">
          ${
            lastMoves.length ? lastMoves.map(m => `
              <div class="flex justify-between items-center" style="gap:10px">
                <div class="small" style="flex:1"><b>${isoToPL(m.date)}</b> â€¢ ${esc(m.note||"â€”")}</div>
                <div style="font-weight:700;color:${Number(m.delta)>=0?'var(--success)':'var(--danger)'}">
                  ${Number(m.delta)>=0?'+':''}${Number(m.delta||0).toFixed(2)}
                </div>
                <button class="btn btn-slate" style="padding:6px 10px" data-act="invDelMove" data-id="${esc(m.id)}">âœ•</button>
              </div>
            `).join("") : `<div class="small">Brak ruchÃ³w.</div>`
          }
        </div>
      `;
      list.appendChild(el);
    }
  }

  async function invAddMove(){
    const selId  = $("invItemSel").value;
    const newName = ($("invNewName").value || "").trim();
    const date   = $("invMoveDate").value || todayISO();
    const delta  = Number($("invMoveDelta").value);
    const note   = ($("invMoveNote").value || "").trim();

    if (!Number.isFinite(delta) || delta===0) return notify("Podaj iloÅ›Ä‡ (rÃ³Å¼nÄ… od 0).");
    if (!date) return notify("Podaj datÄ™.");

    let itemId = selId;

    if (!itemId){
      if (!newName) return notify("Wybierz produkt lub wpisz nowy.");
      const ex = State.invItems.find(x => String(x.name).toLowerCase() === newName.toLowerCase());
      if (ex) itemId = ex.id;
      else {
        itemId = uid();
        State.invItems.push({ id:itemId, name:newName });
        await save("invItems");
      }
    }

    State.invMoves.push({ id:uid(), itemId, date, delta, note, ts:Date.now() });
    await save("invMoves");

    $("invMoveDelta").value = "";
    $("invMoveNote").value = "";
    $("invNewName").value = "";
    $("invItemSel").value = "";

    renderInventory();
  }

  function invQuery(){
    const itemId = $("invQueryItem").value;
    const date = $("invQueryDate").value || todayISO();
    const box = $("invQueryResult");
    box.innerHTML = "";

    if (!itemId) return notify("Wybierz produkt do sprawdzenia.");

    const item = State.invItems.find(x => x.id === itemId);
    const qty = invCalcQtyAtDate(itemId, date);

    const moves = State.invMoves
      .filter(m => m.itemId === itemId && (m.date||"") <= date)
      .sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.ts||0)-(a.ts||0))
      .slice(0,15);

    box.innerHTML = `
      <div class="card" style="border-left:4px solid var(--blue);padding:12px">
        <div class="muted">WYNIK</div>
        <div style="font-weight:700;font-size:20px;margin-top:6px">${esc(item?.name || "")}</div>
        <div class="small" style="margin-top:6px">Stan na dzieÅ„ <b>${isoToPL(date)}</b>:</div>
        <div style="font-weight:700;font-size:26px;margin-top:6px;color:var(--blue)">${qty.toFixed(2)}</div>
        <div class="hr"></div>
        <div class="small"><b>Ruchy do tego dnia</b> (ostatnie 15):</div>
        <div style="display:grid;gap:6px;margin-top:8px">
          ${
            moves.length ? moves.map(m => `
              <div class="flex justify-between items-center" style="gap:10px">
                <div class="small" style="flex:1"><b>${isoToPL(m.date)}</b> â€¢ ${esc(m.note||"â€”")}</div>
                <div style="font-weight:700;color:${Number(m.delta)>=0?'var(--success)':'var(--danger)'}">
                  ${Number(m.delta)>=0?'+':''}${Number(m.delta||0).toFixed(2)}
                </div>
              </div>
            `).join("") : `<div class="small">Brak ruchÃ³w do tego dnia.</div>`
          }
        </div>
      </div>
    `;
  }

  async function invDeleteMove(id){
    if (!await confirmDelete("UsunÄ…Ä‡ ruch?")) return;
    State.invMoves = State.invMoves.filter(x => x.id !== id);
    await save("invMoves");
    renderInventory();
  }

  async function invDeleteItem(id){
    const it = State.invItems.find(x => x.id === id);
    if (!it) return;
    if (!await confirmDialog({title:"USUWANIE", message:`UsunÄ…Ä‡ produkt "${it.name}" oraz caÅ‚Ä… historiÄ™ ruchÃ³w?`, confirmText:"TAK, USUÅƒ", confirmClass:"btn-red"})) return;
    State.invItems = State.invItems.filter(x => x.id !== id);
    State.invMoves = State.invMoves.filter(x => x.itemId !== id);
    await save("invItems");
    await save("invMoves");
    renderInventory();
  }

  /* ===== Knowledge ===== */
  let editKnowId = null; // Zmienna do Å›ledzenia edycji

  function refreshTopicSelect(){
    const sel = $("knowTopic");
    sel.innerHTML = "";
    (State.topics.length ? State.topics : ["OgÃ³lne"]).forEach(t => {
      const o=document.createElement("option");
      o.value=t; o.textContent=t;
      sel.appendChild(o);
    });
  }

  function renderKnowledge(){
    refreshTopicSelect();
    const wrap = $("knowList");
    wrap.innerHTML = "";

    const byTopic = {};
    for (const n of State.knowledge){
      const t = n.topic || "OgÃ³lne";
      if (!byTopic[t]) byTopic[t]=[];
      byTopic[t].push(n);
    }

    const topics = [...new Set([...State.topics, ...Object.keys(byTopic)])].filter(Boolean);

    topics.forEach(t => {
      const items = (byTopic[t] || []).sort((a,b) => (b.dateTS||0)-(a.dateTS||0));
      const sec = document.createElement("div");
      sec.className = "card";
      sec.style.borderLeft = "4px solid var(--purple)";
      sec.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div style="font-weight:700;color:var(--purple)">${esc(t)}</div>
          <div class="small">${items.length} not.</div>
        </div>
      `;

      if (!items.length){
        const p=document.createElement("div");
        p.className="small";
        p.style.marginTop="8px";
        p.textContent="Brak notatek w tym temacie.";
        sec.appendChild(p);
      } else {
        items.forEach(n => {
          const item=document.createElement("div");
          item.style.marginTop="10px";
          item.style.paddingTop="10px";
          item.style.borderTop="1px solid var(--border)";
          item.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <div style="font-weight:700">${esc(n.title||"(bez tytuÅ‚u)")}</div>
                <div class="small">${new Date(n.dateTS||Date.now()).toLocaleDateString("pl-PL")}</div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-blue" style="padding:6px 10px" data-act="knowEdit" data-id="${esc(n.id)}">EDYTUJ</button>
                <button class="btn btn-slate" style="padding:6px 10px" data-act="knowDel" data-id="${esc(n.id)}">USUÅƒ</button>
              </div>
            </div>
            <div style="white-space:pre-wrap;margin-top:6px">${esc(n.body||"")}</div>
          `;
          sec.appendChild(item);
        });
      }

      wrap.appendChild(sec);
    });
  }

  async function addTopic(){
    const t = ($("knowNewTopic").value || "").trim();
    if (!t) return;
    if (!State.topics.includes(t)) State.topics.push(t);
    await save("topics");
    $("knowNewTopic").value = "";
    renderKnowledge();
  }

  async function addKnowledge(){
    const topic = $("knowTopic").value || "OgÃ³lne";
    const title = ($("knowTitle").value || "").trim();
    const body  = ($("knowBody").value || "").trim();

    if (!title && !body) return notify("Wpisz tytuÅ‚ lub treÅ›Ä‡.");

    if (editKnowId) {
        // Tryb edycji
        const n = State.knowledge.find(x => x.id === editKnowId);
        if(n) {
            n.topic = topic;
            n.title = title || "(bez tytuÅ‚u)";
            n.body  = body;
            n.dateTS = Date.now();
        }
        editKnowId = null;
        
        // Reset przycisku
        const btn = $("addKnowBtn");
        btn.textContent = "ZAPISZ NOTATKÄ˜";
    } else {
        // Tryb dodawania
        State.knowledge.push({ id:uid(), topic, title:title||"(bez tytuÅ‚u)", body, dateTS:Date.now() });
    }
    
    await save("knowledge");

    $("knowTitle").value = "";
    $("knowBody").value = "";
    renderKnowledge();
  }

  function startEditKnowledge(id){
    const n = State.knowledge.find(x => x.id === id);
    if (!n) return;
    editKnowId = id;

    // WypeÅ‚nij pola formularza
    $("knowTopic").value = n.topic || "OgÃ³lne";
    $("knowTitle").value = n.title || "";
    $("knowBody").value = n.body || "";

    // ZmieÅ„ tekst przycisku
    const btn = $("addKnowBtn");
    btn.textContent = "ZAPISZ ZMIANY";

    // PrzewiÅ„ do gÃ³ry sekcji
    $("viewKnowledge").scrollIntoView({behavior: "smooth"});
  }

  async function deleteKnowledge(id){
    if (!await confirmDelete("UsunÄ…Ä‡ notatkÄ™?")) return;
    State.knowledge = State.knowledge.filter(x => x.id !== id);
    await save("knowledge");
    
    // JeÅ›li usuwamy edytowanÄ…, zresetuj formularz
    if (editKnowId === id) {
        editKnowId = null;
        $("knowTitle").value = "";
        $("knowBody").value = "";
        $("addKnowBtn").textContent = "ZAPISZ NOTATKÄ˜";
    }
    
    renderKnowledge();
  }

  function editKnowledgeModal(id){
    const n = State.knowledge.find(x => x.id === id);
    if (!n) return;

    const currentTopic = n.topic || "OgÃ³lne";
    const topics = [...new Set([...(State.topics||[]), currentTopic])].filter(Boolean);
    const opts = topics
      .map(t => `<option value="${esc(t)}" ${t === currentTopic ? 'selected' : ''}>${esc(t)}</option>`)
      .join("");

    modalOpen("Edycja notatki", `
      <div class="row cols2">
        <label class="help">Temat
          <select id="mKnowTopic" class="input">${opts}</select>
        </label>
        <label class="help">TytuÅ‚
          <input id="mKnowTitle" type="text" class="input" value="${esc(n.title||"")}">
        </label>
      </div>
      <label class="help">TreÅ›Ä‡
        <textarea id="mKnowBody" class="input" style="height:150px">${esc(n.body||"")}</textarea>
      </label>
      <div class="small">Zmienisz temat, tytuÅ‚ i treÅ›Ä‡. Po zapisie notatka zostanie zaktualizowana.</div>
    `, async ()=>{
      const topic = ($("mKnowTopic").value || "OgÃ³lne").trim();
      const title = ($("mKnowTitle").value || "").trim();
      const body  = ($("mKnowBody").value || "").trim();

      if (!title && !body) { notify("Wpisz tytuÅ‚ lub treÅ›Ä‡."); return; }

      n.topic = topic || "OgÃ³lne";
      n.title = title || "(bez tytuÅ‚u)";
      n.body  = body;
      n.dateTS = Date.now();

      // jeÅ¼eli temat nie istnieje na liÅ›cie, dodaj
      if (topic && !State.topics.includes(topic)) {
        State.topics.push(topic);
        await save("topics");
      }

      await save("knowledge");
      modalClose();
      renderKnowledge();
    });
  }


  /* ===== Export / Import ===== */
  async function exportBackup(){
    const out = {
      meta:{ app:"Pasiecznik ULTRA", exportedAt:new Date().toISOString() },
      data:{
        hives: State.hives,
        reviews: State.reviews,
        queens: State.queens,
        feedings: State.feedings,
        treatments: State.treatments,
        harvests: State.harvests,
        calendar: State.calendar,
        finance: State.finance,
        invItems: State.invItems,
        invMoves: State.invMoves,
        topics: State.topics,
        knowledge: State.knowledge
      }
    };

    const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "pasiecznik_backup_" + new Date().toLocaleDateString("pl-PL").replaceAll("/","-") + ".json";
    a.click();
  }

  async function importBackup(file){
    const txt = await file.text();
    let parsed;
    try { parsed = JSON.parse(txt); } catch { return notify("BÅ‚Ä™dny plik."); }

    if (!await confirmDialog({title:"IMPORT", message:"NadpisaÄ‡ wszystkie dane w aplikacji?", confirmText:"TAK, NADPISZ", confirmClass:"btn-red", hint:"To nadpisze wszystkie dane w aplikacji."})) return;

    const data = parsed.data || parsed;

    State.hives     = data.hives     || [];
    State.reviews   = data.reviews   || [];
    State.queens    = data.queens    || [];
    State.feedings  = data.feedings  || [];
    State.treatments = data.treatments || [];
    State.harvests  = data.harvests  || [];
    State.calendar  = data.calendar  || {};
    State.finance   = data.finance   || [];
    State.invItems  = data.invItems  || [];
    State.invMoves  = data.invMoves  || [];
    State.topics    = data.topics    || ["OgÃ³lne"];
    State.knowledge = data.knowledge || [];

    State.hives.forEach(h => {
      if (h.label == null) h.label = h.id;
      if (h.place == null) h.place = "";
      if (h.kind == null) h.kind = "rodzina";
      if (h.year == null) h.year = thisYear;
      if (h.nextVisitDate == null) h.nextVisitDate = "";
    });

    await dbSet("hives", State.hives);
    await dbSet("reviews", State.reviews);
    await dbSet("queens", State.queens);
    await dbSet("feedings", State.feedings);
    await dbSet("treatments", State.treatments);
    await dbSet("harvests", State.harvests);
    await dbSet("calendar", State.calendar);
    await dbSet("finance", State.finance);
    await dbSet("invItems", State.invItems);
    await dbSet("invMoves", State.invMoves);
    await dbSet("topics", State.topics);
    await dbSet("knowledge", State.knowledge);

    notify("PrzywrÃ³cono dane.");
    renderView("hives", null, true);
  }

  /* ===== Add Hive NEW (Modal) ===== */
  function openAddHiveModal(){
    $("newHiveLabel").value = "";
    $("newHiveYear").value = String(thisYear);
    $("newHivePlace").value = "";
    $("newHiveType").value = "rodzina";

    const ov = $("addHiveOverlay");
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }

  function closeAddHiveModal(){
    const ov = $("addHiveOverlay");
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
  }

  async function saveNewHive(){
    const label = ($("newHiveLabel").value || "").trim();
    if (!label) return notify("Podaj numer/nazwÄ™ ula.");

    const id = label;
    if (State.hives.some(h => h.id === id)){
      return notify("Taki ul juÅ¼ istnieje!");
    }

    const year = Number($("newHiveYear").value) || thisYear;
    const place = ($("newHivePlace").value || "").trim();
    const kind = $("newHiveType").value;

    State.hives.push({
      id,
      label: id,
      place,
      kind,
      year,
      nextVisitDate: "",
      isArchived: false
    });

    await save("hives");
    closeAddHiveModal();
    renderHives();
    notify("Dodano ul!");
  }

  /* ===== Archive Hive Modal Logic ===== */
  function openArchiveModal(){
      $("archiveReason").value = "";
      const ov = $("archiveHiveOverlay");
      ov.classList.add("show");
      ov.setAttribute("aria-hidden","false");
  }
  function closeArchiveModal(){
      const ov = $("archiveHiveOverlay");
      ov.classList.remove("show");
      ov.setAttribute("aria-hidden","true");
  }
  async function confirmArchive(){
      const reason = ($("archiveReason").value || "").trim();
      const hive = State.hives.find(h => h.id === State.currentHive);
      
      if (hive) {
          if (hive.isArchived) {
              // JeÅ¼eli juÅ¼ jest zarchiwizowany, to PRZYWRÃ“Ä† (od-archiwizuj)
              hive.isArchived = false;
              // Opcjonalnie wyczyÅ›Ä‡ stare notatki archiwizacji, jeÅ›li chcesz
              notify("Ul przywrÃ³cony do aktywnych.");
          } else {
              // ARCHIWIZUJ
              hive.isArchived = true;
              // Zapisz powÃ³d w notatce (opcjonalnie moÅ¼na dodaÄ‡ pole archiveReason do modelu)
              if(reason) {
                  // Dodaj wpis do przeglÄ…dÃ³w jako "Notatka o archiwizacji"
                  State.reviews.push({ 
                      id:uid(), 
                      hiveId: hive.id, 
                      visitDate: todayISO(), 
                      note: "ARCHIWIZACJA: " + reason, 
                      ts:Date.now() 
                  });
                  await save("reviews");
              }
              notify("Ul zarchiwizowany.");
          }
          await save("hives");
          closeArchiveModal();
          renderView("hives", null, true);
      }
  }


  /* ===== Global click delegation ===== */
  async function onBodyClick(e){
    const b = e.target.closest("[data-act]");
    if (!b) return;
    const act = b.getAttribute("data-act");
    const id = b.getAttribute("data-id");

    if (act === "revEdit") return startEditReview(id);
    if (act === "revDel") return deleteReview(id);

    if (act === "feedEdit") return startEditFeeding(id);
    if (act === "feedDel") return deleteFeeding(id);

    
    if (act === "editTreat") return startEditTreatment(id);
    if (act === "delTreat")  return deleteTreatment(id);
    
    if (act === "queenEdit") return startEditQueen(id);
    if (act === "queenDel") return deleteQueen(id);
    if (act === "queenSetCurrent") return setCurrentQueen(id);

    if (act === "harvEdit") return startEditHarvest(id);
    if (act === "harvDel") return deleteHarvest(id);

    if (act === "finDel") return deleteFinance(id);

    if (act === "invDelMove") return invDeleteMove(id);
    if (act === "invDelItem") return invDeleteItem(id);

    if (act === "knowEdit") return startEditKnowledge(id);
    if (act === "knowDel") return deleteKnowledge(id);
  }

  /* ===== START ===== */
  document.addEventListener("DOMContentLoaded", async () => {
    try{
      await openDB();
      await loadAll();

      $("topNav").addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-view]");
        if (!btn) return;
        renderView(btn.dataset.view, null, true);
      });

      // ZMIANA: ObsÅ‚uga nowego modala dodawania ula
      $("addHiveBtn").addEventListener("click", openAddHiveModal);
      $("addHiveClose").addEventListener("click", closeAddHiveModal);
      $("addHiveCancel").addEventListener("click", closeAddHiveModal);
      $("addHiveSave").addEventListener("click", saveNewHive);
      $("addHiveOverlay").addEventListener("click", (e)=>{
         if(e.target === $("addHiveOverlay")) closeAddHiveModal();
      });

      // ZMIANA: ObsÅ‚uga modala archiwizacji
      $("archiveHiveBtn").addEventListener("click", () => {
          const hive = State.hives.find(h => h.id === State.currentHive);
          if(hive && hive.isArchived) {
              // Szybkie przywracanie bez modala (albo z prostym confirmem)
              confirmArchive(); 
          } else {
              openArchiveModal();
          }
      });
      $("archiveHiveClose").addEventListener("click", closeArchiveModal);
      $("archiveHiveCancel").addEventListener("click", closeArchiveModal);
      $("archiveHiveConfirm").addEventListener("click", confirmArchive);
      $("archiveHiveOverlay").addEventListener("click", (e)=>{
         if(e.target === $("archiveHiveOverlay")) closeArchiveModal();
      });


      $("backBtn").addEventListener("click", ()=>renderView("hives", null, true));

      $("fltReviewBtn").addEventListener("click", ()=>{ Filters.review=!Filters.review; renderHives(); });
      $("fltQueenBtn").addEventListener("click", ()=>{ Filters.queen=!Filters.queen; renderHives(); });
      // Archive Filter Toggle
      $("fltArchivedBtn").addEventListener("click", ()=>{ 
          Filters.archived=!Filters.archived; 
          // Reset other filters to avoid confusion
          if(Filters.archived) { Filters.review=false; Filters.queen=false; }
          renderHives(); 
      });

      $("fltClearBtn").addEventListener("click", ()=>{ Filters.review=false; Filters.queen=false; Filters.archived=false; renderHives(); });

      $("saveHiveMetaBtn").addEventListener("click", saveHiveMeta);

      $("revSaveBtn").addEventListener("click", saveReview);

      $("feedSaveBtn").addEventListener("click", saveFeeding);
      $("feedClearBtn").addEventListener("click", ()=>{ clearFeedingEdit(); });

      // Leczenie
      $("treatSaveBtn").addEventListener("click", addTreatment);
      $("treatClearBtn").addEventListener("click", ()=>{ $("treatType").value=""; $("treatQty").value=""; editTreatId=null; const btn=$("treatSaveBtn"); btn.textContent="ZAPISZ LECZENIE"; btn.classList.remove("btn-blue"); btn.classList.add("btn-red"); });

      $("queenSaveBtn").addEventListener("click", saveQueen);
      $("queenClearBtn").addEventListener("click", ()=>{ clearQueenEdit(); });

      $("harvSaveBtn").addEventListener("click", saveHarvest);
      $("harvClearBtn").addEventListener("click", ()=>{ clearHarvestEdit(); });

      $("addFinBtn").addEventListener("click", addFinance);
      $("finDate").value = todayISO();

      $("invAddMoveBtn").addEventListener("click", invAddMove);
      $("invQueryBtn").addEventListener("click", invQuery);
      $("invMoveDate").value = todayISO();
      $("invQueryDate").value = todayISO();

      $("addTopicBtn").addEventListener("click", addTopic);
      $("addKnowBtn").addEventListener("click", addKnowledge);

      $("exportBtn").addEventListener("click", exportBackup);
      $("importFile").addEventListener("change", async (e)=>{
        const f = e.target.files?.[0];
        e.target.value="";
        if (!f) return;
        await importBackup(f);
      });

      // VOICE NOTE LOGIC
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const micBtn = $("voiceNoteBtn");
      
      if (SpeechRecognition) {
          const recognition = new SpeechRecognition();
          recognition.lang = "pl-PL";
          recognition.continuous = true; // ZMIANA: CiÄ…gÅ‚e nasÅ‚uchiwanie
          recognition.interimResults = false;

          let isRecording = false;

          // WAKE LOCK LOGIC
          let wakeLock = null;
          async function requestWakeLock() {
            try {
              if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
              }
            } catch (err) { console.warn("Wake Lock error:", err); }
          }
          async function releaseWakeLock() {
            if (wakeLock) {
              await wakeLock.release();
              wakeLock = null;
            }
          }

          micBtn.addEventListener("click", () => {
              if (isRecording) {
                  recognition.stop();
              } else {
                  try {
                      recognition.start();
                  } catch(e) {
                      console.warn("Speech recognition busy/error", e);
                  }
              }
          });

          recognition.onstart = () => {
              isRecording = true;
              requestWakeLock(); // START WAKE LOCK
              micBtn.classList.add("btn-mic-active");
              micBtn.textContent = "ğŸ¤ SÅUCHAM... (MÃ“W TERAZ)";
          };

          recognition.onend = () => {
              isRecording = false;
              releaseWakeLock(); // STOP WAKE LOCK
              micBtn.classList.remove("btn-mic-active");
              micBtn.textContent = "ğŸ¤ NAGRAJ NOTATKÄ˜ (Start/Stop)";
          };

          recognition.onresult = (event) => {
              const lastResultIdx = event.results.length - 1;
              const transcript = event.results[lastResultIdx][0].transcript.trim();
              
              // Sprawdzenie komendy koÅ„czÄ…cej
              if (transcript.toLowerCase().includes("koniec nagrywania") || transcript.toLowerCase().includes("koniec notatki")) {
                  const cleanedText = transcript.replace(/koniec nagrywania|koniec notatki/gi, "").trim();
                  
                  const noteBox = $("revNote");
                  const currentVal = noteBox.value.trim();
                  if (cleanedText) {
                      noteBox.value = currentVal ? (currentVal + " " + cleanedText) : cleanedText;
                  }

                  recognition.stop();
                  
                  // AUTO SAVE
                  setTimeout(() => {
                      $("revSaveBtn").click();
                      notify("Zapisano gÅ‚osem!");
                  }, 500);
                  return;
              }

              const noteBox = $("revNote");
              const currentVal = noteBox.value.trim();
              noteBox.value = currentVal ? (currentVal + " " + transcript) : transcript;
          };
          
          recognition.onerror = (e) => {
              console.error(e);
              isRecording = false;
              releaseWakeLock();
              micBtn.classList.remove("btn-mic-active");
              micBtn.textContent = "ğŸ¤ NAGRAJ NOTATKÄ˜ (Start/Stop)";
              notify("BÅ‚Ä…d rozpoznawania mowy lub brak internetu.");
          };
      } else {
          micBtn.style.display = "none";
      }


      document.body.addEventListener("click", onBodyClick);

      const p = new URLSearchParams(location.search);
      const v = p.get("v") || "hives";
      const id = p.get("id");
      if (v === "details" && id) renderView("details", id, false);
      else renderView(v, null, false);

    } catch(err){
      console.error(err);
      document.body.innerHTML = `<h1 style="color:red;padding:16px">BÅ‚Ä…d aplikacji: ${esc(err?.message||String(err))}</h1>`;
    }
  });

})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(console.warn);
  }
</script>

<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

</body>
</html>
